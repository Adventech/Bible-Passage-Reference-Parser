<!DOCTYPE html>  <html> <head>   <title>bcv_parser.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="bcv_parser.html">                 bcv_parser.coffee               </a>                                           <a class="source" href="bcv_passage.html">                 bcv_passage.coffee               </a>                                           <a class="source" href="en_regexps.html">                 en_regexps.coffee               </a>                                           <a class="source" href="en_translations.html">                 en_translations.coffee               </a>                                           <a class="source" href="es_regexps.html">                 es_regexps.coffee               </a>                                           <a class="source" href="es_translations.html">                 es_translations.coffee               </a>                                           <a class="source" href="en_spec.html">                 en_spec.coffee               </a>                                           <a class="source" href="es_spec.html">                 es_spec.coffee               </a>                                           <a class="source" href="eu_es_spec.html">                 eu_es_spec.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               bcv_parser.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>This class takes a string and identifies Bible passage references in that string. It's designed to handle how people actually type Bible passages and tries fairly hard to make sense of dubious possibilities.</p>

<p>The aggressiveness is tunable, to a certain extent, using the below <code>options</code>. It's probably going to be too aggressive for general text parsing (the "is 2" in "There is 2 much" becomes "Isa.2", for example). </p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Export to whatever the current context is.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">root = </span><span class="k">this</span>

<span class="k">class</span> <span class="nx">bcv_parser</span>
	<span class="nv">s: </span><span class="s2">&quot;&quot;</span>
	<span class="nv">entities: </span><span class="p">[]</span>
	<span class="nv">passage: </span><span class="kc">null</span>
	<span class="nv">regexps: </span><span class="p">{}</span>
	<span class="nv">default_options: </span><span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h2>Main Options</h2>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">options:</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <h3>OSIS Output</h3>

<ul>
<li><code>combine</code>:  "Matt 5, 6, 7" -> "Matt.5-Matt.7".</li>
<li><code>separate</code>: "Matt 5, 6, 7" -> "Matt.5,Matt.6,Matt.7".</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">consecutive_combination_strategy: </span><span class="s2">&quot;combine&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <ul>
<li><code>b</code>: OSIS refs get reduced to the shortest possible. "Gen.1.1-Gen.50.26" and "Gen.1-Gen.50" -> "Gen", while "Gen.1.1-Gen.2.25" -> "Gen.1-Gen.2".</li>
<li><code>bc</code>: OSIS refs get reduced to complete chapters if possible, but not whole books. "Gen.1.1-Gen.50.26" -> "Gen.1-Gen.50".</li>
<li><code>bcv</code>: OSIS refs always include the full book, chapter, and verse. "Gen.1" -> "Gen.1.1-Gen.1.31".</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">osis_compaction_strategy: </span><span class="s2">&quot;b&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <h3>Sequence</h3>

<ul>
<li><code>ignore</code>: ignore any books on their own in sequences ("Gen Is 1" -> "Isa.1").</li>
<li><code>include</code>: any books that appear on their own get parsed according to <code>book_alone_strategy</code> ("Gen Is 1" means "Gen.1-Gen.50,Isa.1" if <code>book_alone_strategy</code> is <code>full</code> or <code>ignore</code>, or "Gen.1,Isa.1" if it's <code>first_chapter</code>).</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">book_sequence_strategy: </span><span class="s2">&quot;ignore&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <ul>
<li><code>ignore</code>: "Matt 99, Gen 1" sequence index starts at <code>Gen 1</code>.</li>
<li><code>include</code>: "Matt 99, Gen 1" sequence index starts at <code>Matt 99</code>.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">invalid_sequence_strategy: </span><span class="s2">&quot;ignore&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <ul>
<li><code>combine</code>: consecutive references are combined into a single OSIS list: Gen 1, 2 -> "Gen.1,Gen.2".</li>
<li><code>separate</code>: consecutive references are separated into their component parts: Gen 1, 2 -> "Gen.1" and "Gen.2".</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">sequence_combination_strategy: </span><span class="s2">&quot;combine&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <h3>Potentially Invalid Input</h3>

<ul>
<li><code>ignore</code>: Don't include invalid passages in <code>@parsed_entities()</code>.</li>
<li><code>include</code>: Include invalid passages in <code>@parsed_entities()</code> (they still don't have OSIS values).</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">invalid_passage_strategy: </span><span class="s2">&quot;ignore&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <ul>
<li><code>error</code>: zero chapters ("Matt 0") are invalid.</li>
<li><code>upgrade</code>: zero chapters are upgraded to 1: "Matt 0" -> "Matt 1".
Unlike <code>zero_verse_strategy</code>, chapter 0 isn't allowed.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">zero_chapter_strategy: </span><span class="s2">&quot;error&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <ul>
<li><code>error</code>: zero verses ("Matt 5:0") are invalid.</li>
<li><code>upgrade</code>: zero verses are upgraded to 1: "Matt 5:0" -> "Matt 5:1".</li>
<li><code>allow</code>: zero verses are kept as-is: "Matt 5:0" -> "Matt 5:0". Some traditions use 0 for Psalm titles.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">zero_verse_strategy: </span><span class="s2">&quot;error&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <h3>Context</h3>

<ul>
<li><code>ignore</code>: any books that appear on their own don't get parsed as books ("Gen saw" doesn't trigger a match, but "Gen 1" does).</li>
<li><code>full</code>: any books that appear on their own get parsed as the complete book ("Gen" means "Gen.1-Gen.50").</li>
<li><code>first_chapter</code>: any books that appear on their own get parsed as the first chapter ("Gen" means "Gen.1").</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">book_alone_strategy: </span><span class="s2">&quot;ignore&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <ul>
<li><code>delete</code>: remove any digits at the end of a sequence that are preceded by spaces and immediately followed by a <code>\w</code>: "Matt 5 1Hi" -> "Matt.5". This is better for text extraction.</li>
<li><code>include</code>: keep any digits at the end of a sequence that are preceded by spaces and immediately followed by a <code>\w</code>: "Matt 5 1Hi" -> "Matt.5.1". This is better for query parsing.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">captive_end_digits_strategy: </span><span class="s2">&quot;delete&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <ul>
<li><code>verse</code>: treat "Jer 33-11" as "Jer 33:11" (end before start) and "Heb 13-15" as "Heb.13.15" (end range too high).</li>
<li><code>sequence</code>: treat them as sequences.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">end_range_digits_strategy: </span><span class="s2">&quot;verse&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Remember default options for later use.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">constructor: </span><span class="o">-&gt;</span>
		<span class="vi">@options = </span><span class="p">{}</span>
		<span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">val</span> <span class="k">of</span> <span class="nx">bcv_parser</span><span class="o">::</span><span class="nx">options</span>
			<span class="nx">@options</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <h2>Parse-related Functions</h2>

<p>Parse a string and prepare the object for further interrogation, depending on what's needed.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">parse: </span><span class="nf">(s) -&gt;</span>
		<span class="nx">@reset</span><span class="p">()</span>
		<span class="vi">@s = </span><span class="nx">s</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Replace any control characters already in the string.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">s = </span><span class="nx">@replace_control_characters</span> <span class="nx">s</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Get a string representation suitable for passing to the parser.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="p">[</span><span class="nx">s</span><span class="p">,</span> <span class="nx">@passage</span><span class="p">.</span><span class="nx">books</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@match_books</span> <span class="nx">s</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Replace potential BCVs one at a time to reduce processing time on long strings.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">entities = </span><span class="nx">@match_passages</span> <span class="nx">s</span>
		<span class="vi">@entities = </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Loop through them rather than handle them all at once to prevent context leakage (e.g., translations back-propagating through unrelated entities)</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">for</span> <span class="nx">entity</span> <span class="k">in</span> <span class="nx">entities</span>
			<span class="p">[</span><span class="nx">accum</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@passage</span><span class="p">.</span><span class="nx">handle_array</span> <span class="p">[</span><span class="nx">entity</span><span class="p">]</span>
			<span class="vi">@entities = </span><span class="nx">@entities</span><span class="p">.</span><span class="nx">concat</span> <span class="nx">accum</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Allow chaining.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">this</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>If we have a new string to parse, reset any values from previous parses.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">reset: </span><span class="o">-&gt;</span>
		<span class="vi">@s = </span><span class="s2">&quot;&quot;</span>
		<span class="vi">@entities = </span><span class="p">[]</span>
		<span class="k">if</span> <span class="nx">@passage</span>
			<span class="vi">@passage.books = </span><span class="p">[]</span>
			<span class="vi">@passage.indices = </span><span class="p">{}</span>
		<span class="k">else</span>
			<span class="vi">@passage = </span><span class="k">new</span> <span class="nx">bcv_passage</span>
			<span class="vi">@passage.options = </span><span class="nx">@options</span>
			<span class="vi">@passage.translations = </span><span class="nx">@translations</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Override default options.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">set_options: </span><span class="nf">(options) -&gt;</span>
		<span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">val</span> <span class="k">of</span> <span class="nx">options</span>
			<span class="nx">@options</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Whether to use books and abbreviations from the Apocrypha. Takes a boolean argument: <code>true</code> to include the Apocrypha and <code>false</code> to not. Defaults to <code>false</code>. Returns the <code>bcv_parser</code> object.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">include_apocrypha: </span><span class="nf">(arg) -&gt;</span>
		<span class="k">return</span> <span class="k">this</span> <span class="nx">unless</span> <span class="nx">arg</span><span class="o">?</span>
		<span class="k">if</span> <span class="nx">arg</span> <span class="o">is</span> <span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Add them to the list of available books.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">val</span> <span class="k">of</span> <span class="nx">@translations</span><span class="p">.</span><span class="nx">apocrypha</span><span class="p">.</span><span class="nx">order</span>
				<span class="nx">@translations</span><span class="p">.</span><span class="nx">default</span><span class="p">.</span><span class="nx">order</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span>
			<span class="nx">@translations</span><span class="p">.</span><span class="nx">default</span><span class="p">.</span><span class="nx">chapters</span><span class="p">.</span><span class="nx">Ps</span><span class="p">[</span><span class="mi">150</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@translations</span><span class="p">.</span><span class="nx">default</span><span class="p">.</span><span class="nx">chapters</span><span class="p">.</span><span class="nx">Ps151</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Prepend them to the book regexps--some of the Apocryphal books (Esther and EpJer) should take precedence over other books.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">unless</span> <span class="nx">@regexps</span><span class="p">.</span><span class="nx">books</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">apocrypha</span><span class="o">?</span> <span class="o">and</span> <span class="nx">@regexps</span><span class="p">.</span><span class="nx">books</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">apocrypha</span> <span class="o">is</span> <span class="kc">true</span>
				<span class="k">for</span> <span class="nx">book</span> <span class="k">in</span> <span class="nx">@regexps</span><span class="p">.</span><span class="nx">apocrypha</span>
					<span class="nx">@regexps</span><span class="p">.</span><span class="nx">books</span><span class="p">.</span><span class="nx">unshift</span> <span class="nx">book</span>
		<span class="k">else</span> <span class="k">if</span> <span class="nx">arg</span> <span class="o">is</span> <span class="kc">false</span>
			<span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">val</span> <span class="k">of</span> <span class="nx">@translations</span><span class="p">.</span><span class="nx">apocrypha</span><span class="p">.</span><span class="nx">order</span>
				<span class="k">delete</span> <span class="nx">@translations</span><span class="p">.</span><span class="nx">default</span><span class="p">.</span><span class="nx">order</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="k">if</span> <span class="nx">@translations</span><span class="p">.</span><span class="nx">default</span><span class="p">.</span><span class="nx">order</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="o">?</span>
			<span class="k">if</span> <span class="nx">@regexps</span><span class="p">.</span><span class="nx">books</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">apocrypha</span><span class="o">?</span> <span class="o">and</span> <span class="nx">@regexps</span><span class="p">.</span><span class="nx">books</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">apocrypha</span> <span class="o">is</span> <span class="kc">true</span>
				<span class="k">for</span> <span class="nx">book</span> <span class="k">in</span> <span class="nx">@regexps</span><span class="p">.</span><span class="nx">books</span>
					<span class="k">if</span> <span class="nx">book</span><span class="p">.</span><span class="nx">apocrypha</span><span class="o">?</span> <span class="nx">book</span><span class="p">.</span><span class="nx">apocrypha</span> <span class="o">is</span> <span class="kc">true</span> <span class="k">then</span> <span class="nx">@regexps</span><span class="p">.</span><span class="nx">books</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span> <span class="k">else</span> <span class="k">break</span>
			<span class="nx">@translations</span><span class="p">.</span><span class="nx">default</span><span class="p">.</span><span class="nx">chapters</span><span class="p">.</span><span class="nx">Ps</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span> <span class="k">if</span> <span class="nx">@translations</span><span class="p">.</span><span class="nx">default</span><span class="p">.</span><span class="nx">chapters</span><span class="p">.</span><span class="nx">Ps</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">151</span>
		<span class="k">this</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Replace control characters and spaces since we replace books with a specific character pattern. The string changes, but the length stays the same so that indices remain valid.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">replace_control_characters: </span><span class="nf">(s) -&gt;</span>
		<span class="nx">s</span><span class="p">.</span><span class="nx">replace</span> <span class="nx">@regexps</span><span class="p">.</span><span class="nx">control</span><span class="p">,</span> <span class="s2">&quot; &quot;</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Find and replace instances of Bible books.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">match_books: </span><span class="nf">(s) -&gt;</span>
		<span class="nv">books = </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Replace all book strings.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">for</span> <span class="nx">book</span> <span class="k">in</span> <span class="nx">@regexps</span><span class="p">.</span><span class="nx">books</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>I explored using the following code, using array concatenation instead of replacing text directly, but found that it didn't offer performance improvements.</p>

<p><code>parts = []</code>
<code>prev_index = 0</code>
<code>while match = book.regexp.exec s</code>
<code>books.push value: match[0], parsed: book.osis</code>
<code>if match.index != prev_index</code>
<code>parts.push s.substr(prev_index, match.index - prev_index)</code>
<code>extra = if book.extra? then "/" + book.extra else ""</code>
<code>parts.push "\x1f#{books.length - 1}#{extra}\x1f"</code>
<code>prev_index = match.index + match[0].length</code>
<code>if parts.length &gt; 0</code>
<code>parts.push s.substr(prev_index)</code>
<code>s = parts.join ""</code></p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nv">s = </span><span class="nx">s</span><span class="p">.</span><span class="nx">replace</span> <span class="nx">book</span><span class="p">.</span><span class="nx">regexp</span><span class="p">,</span> <span class="nf">(full, prev, bk) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p><code>value</code> contains the raw string; <code>book.osis</code> is the osis value for the book.</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nx">books</span><span class="p">.</span><span class="nx">push</span> <span class="nv">value: </span><span class="nx">bk</span><span class="p">,</span> <span class="nv">parsed: </span><span class="nx">book</span><span class="p">.</span><span class="nx">osis</span>
				<span class="nv">extra = </span><span class="k">if</span> <span class="nx">book</span><span class="p">.</span><span class="nx">extra</span><span class="o">?</span> <span class="k">then</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="nx">book</span><span class="p">.</span><span class="nx">extra</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
				<span class="s2">&quot;#{prev}\x1f#{books.length - 1}#{extra}\x1f&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Replace translations.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">s = </span><span class="nx">s</span><span class="p">.</span><span class="nx">replace</span> <span class="nx">@regexps</span><span class="p">.</span><span class="nx">translations</span><span class="p">,</span> <span class="nf">(match) -&gt;</span>
			<span class="nx">books</span><span class="p">.</span><span class="nx">push</span> <span class="nv">value: </span><span class="nx">match</span><span class="p">,</span> <span class="nv">parsed: </span><span class="nx">match</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span>
			<span class="s2">&quot;\x1e#{books.length - 1}\x1e&quot;</span><span class="p">;</span>
		<span class="p">[</span><span class="nx">s</span><span class="p">,</span> <span class="nx">@get_book_indices</span><span class="p">(</span><span class="nx">books</span><span class="p">,</span> <span class="nx">s</span><span class="p">)]</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Get the string index for all the books / translations, adding the start index as a new key.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">get_book_indices: </span><span class="nf">(books, s) -&gt;</span>
		<span class="nv">add_index = </span><span class="mi">0</span>
		<span class="nv">re = </span><span class="err">///</span>
			<span class="p">([</span><span class="err">\</span><span class="nx">x1f</span><span class="err">\</span><span class="nx">x1e</span><span class="p">])</span>	<span class="c1"># opening book or translation</span>
			<span class="p">(</span><span class="err">\</span><span class="nx">d</span><span class="o">+</span><span class="p">)</span>			<span class="c1"># the number</span>
			<span class="p">(</span><span class="o">?:</span><span class="err">/[a-z])?		# optional extra identifier</span>
			<span class="err">\</span><span class="mi">1</span>				<span class="c1"># closing delimeter</span>
			<span class="o">/</span><span class="err">//g</span>
		<span class="k">while</span> <span class="nv">match = </span><span class="nx">re</span><span class="p">.</span><span class="nx">exec</span> <span class="nx">s</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Keep track of the actual start index.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">books</span><span class="p">[</span><span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">]].</span><span class="nv">start_index = </span><span class="nx">match</span><span class="p">.</span><span class="nx">index</span> <span class="o">+</span> <span class="nx">add_index</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Add the difference between the real length of the book and what we replaced it with (match[0] is the replacement).</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">add_index</span> <span class="o">+=</span> <span class="nx">books</span><span class="p">[</span><span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">]].</span><span class="nx">value</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">match</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span>
		<span class="nx">books</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>Create an array of all the potential bcv matches in the string.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">match_passages: </span><span class="nf">(s) -&gt;</span>
		<span class="nv">passages = </span><span class="p">[]</span>
		<span class="k">while</span> <span class="nv">match = </span><span class="nx">@regexps</span><span class="p">.</span><span class="nx">escaped_passage</span><span class="p">.</span><span class="nx">exec</span> <span class="nx">s</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <ul>
<li><code>match[0]</code> includes the preceding character (if any) for bounding.</li>
<li><code>match[1]</code> is the full match minus the character preceding the match used for bounding.</li>
<li>match[2]` is the book id.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="p">[</span><span class="nx">full</span><span class="p">,</span> <span class="nx">part</span><span class="p">,</span> <span class="nx">book_id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">match</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>Adjust the <code>index</code> to use the <code>part</code> offset rather than the <code>full</code> offset. We use it below for <code>captive_end_digits</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">match</span><span class="p">.</span><span class="nx">index</span> <span class="o">+=</span> <span class="nx">full</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">part</span><span class="p">.</span><span class="nx">length</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>Remove most three+-character digits at the end; they won't match.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="sr">/\s[2-9]\d\d\s*$|\s\d{4,}\s*$/</span><span class="p">).</span><span class="nx">test</span> <span class="nx">part</span>
				<span class="nv">re = </span><span class="sr">/\s+\d+\s*$/</span>
				<span class="nv">part = </span><span class="nx">part</span><span class="p">.</span><span class="nx">replace</span> <span class="nx">re</span><span class="p">,</span> <span class="s2">&quot;&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>Clean up the end of the match to avoid irrelevant context.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">unless</span> <span class="sr">/[\d\x1f\x1e]$/</span><span class="p">.</span><span class="nx">test</span> <span class="nx">part</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Remove superfluous characters from the end of the match.</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nv">part = </span><span class="nx">@replace_match_end</span> <span class="nx">part</span>
			<span class="k">if</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">captive_end_digits_strategy</span> <span class="o">is</span> <span class="s2">&quot;delete&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>If the match ends with a space+digit and is immediately followed by a word character, ignore the space+digit: Matt 1, 2Text</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nv">next_char = </span><span class="nx">match</span><span class="p">.</span><span class="nx">index</span> <span class="o">+</span> <span class="nx">part</span><span class="p">.</span><span class="nx">length</span>
				<span class="nv">part = </span><span class="nx">part</span><span class="p">.</span><span class="nx">replace</span> <span class="sr">/[\s*]+\d+$/</span><span class="p">,</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="nx">next_char</span> <span class="o">and</span> <span class="sr">/^\w/</span><span class="p">.</span><span class="nx">test</span> <span class="nx">s</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">next_char</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>If the match ends with a translation indicator, remove any numbers afterward. This situation generally occurs in cases like, "Ps 1:1 ESV 1 Blessed is...", where the final <code>1</code> is a verse number that's part of the text.</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nv">part = </span><span class="nx">part</span><span class="p">.</span><span class="nx">replace</span> <span class="sr">/(\x1e[)\]]?)[\s*]*\d+$/</span><span class="p">,</span> <span class="s2">&quot;$1&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>Though PEG.js doesn't have to be case-sensitive, using the case-insensitive feature involves some repeated processing. By lower-casing here, we only pay the cost once. The grammar for words like "also" is case-sensitive; we can safely lowercase ascii letters without changing indices. We don't just call .toLowerCase() because it could affect the length of the string if it contains certain characters; maintaining the indices is the most important thing.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nv">part = </span><span class="nx">part</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[A-Z]+/g</span><span class="p">,</span> <span class="nf">(capitals) -&gt;</span> <span class="nx">capitals</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">())</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>If we're in a cb situation, the first character won't be a book control character, which would throw off the <code>start_index</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nv">start_index_adjust = </span><span class="k">if</span> <span class="nx">part</span><span class="p">.</span><span class="nx">substr</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">is</span> <span class="s2">&quot;\x1f&quot;</span> <span class="k">then</span> <span class="mi">0</span> <span class="k">else</span> <span class="nx">part</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;\x1f&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <ul>
<li><code>match</code> is important for the length and whether it contains control characters, neither of which we've changed inconsistently with the original string. The <code>part</code> may be shorter than originally matched, but that's only to remove unneeded characters at the end.</li>
<li><code>grammar</code> is the external PEG parser.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nv">passage = value: </span><span class="nx">grammar</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">part</span><span class="p">),</span> <span class="nv">type: </span><span class="s2">&quot;base&quot;</span><span class="p">,</span> <span class="nv">start_index: </span><span class="nx">@passage</span><span class="p">.</span><span class="nx">books</span><span class="p">[</span><span class="nx">book_id</span><span class="p">].</span><span class="nx">start_index</span> <span class="o">-</span> <span class="nx">start_index_adjust</span><span class="p">,</span> <span class="nv">match: </span><span class="nx">part</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>Are we looking at a single book on its own that could be part of a range like "1-2 Sam"?</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">book_alone_strategy</span> <span class="o">is</span> <span class="s2">&quot;full&quot;</span> <span class="o">and</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">and</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">type</span> <span class="o">is</span> <span class="s2">&quot;b&quot;</span> <span class="o">and</span> <span class="nx">start_index_adjust</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">@passage</span><span class="p">.</span><span class="nx">books</span><span class="p">[</span><span class="nx">book_id</span><span class="p">].</span><span class="nx">parsed</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">and</span> <span class="sr">/^[234]/</span><span class="p">.</span><span class="nx">test</span> <span class="nx">@passage</span><span class="p">.</span><span class="nx">books</span><span class="p">[</span><span class="nx">book_id</span><span class="p">].</span><span class="nx">parsed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
				<span class="nx">@create_book_range</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">passage</span><span class="p">,</span> <span class="nx">book_id</span>
			<span class="nx">passages</span><span class="p">.</span><span class="nx">push</span> <span class="nx">passage</span>
		<span class="nx">passages</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>Remove unnecessary characters from the end of the match.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">replace_match_end: </span><span class="nf">(part) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>Split the string on valid ending characters. Remove whatever's leftover at the end of the string. It would be easier to do <code>part.split(@regexps.match_end_split).pop()</code>, but IE doesn't handle empty strings at the end.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">remove = </span><span class="nx">part</span><span class="p">.</span><span class="nx">length</span>
		<span class="k">while</span> <span class="nv">match = </span><span class="nx">@regexps</span><span class="p">.</span><span class="nx">match_end_split</span><span class="p">.</span><span class="nx">exec</span> <span class="nx">part</span>
			<span class="nv">remove = </span><span class="nx">match</span><span class="p">.</span><span class="nx">index</span> <span class="o">+</span> <span class="nx">match</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span>
		<span class="k">if</span> <span class="nx">remove</span> <span class="o">&lt;</span> <span class="nx">part</span><span class="p">.</span><span class="nx">length</span>
			<span class="nv">part = </span><span class="nx">part</span><span class="p">.</span><span class="nx">substr</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">remove</span>
		<span class="nx">part</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>If a book is on its own, check whether it's preceded by something that indicates it's a book range like "1-2 Samuel".</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">create_book_range: </span><span class="nf">(s, passage, book_id) -&gt;</span>
		<span class="nv">cases = </span><span class="p">[</span><span class="nx">bcv_parser</span><span class="o">::</span><span class="nx">regexps</span><span class="p">.</span><span class="nx">first</span><span class="p">,</span> <span class="nx">bcv_parser</span><span class="o">::</span><span class="nx">regexps</span><span class="p">.</span><span class="nx">second</span><span class="p">,</span> <span class="nx">bcv_parser</span><span class="o">::</span><span class="nx">regexps</span><span class="p">.</span><span class="nx">third</span><span class="p">]</span>
		<span class="nv">limit = </span><span class="nb">parseInt</span> <span class="nx">@passage</span><span class="p">.</span><span class="nx">books</span><span class="p">[</span><span class="nx">book_id</span><span class="p">].</span><span class="nx">parsed</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">10</span>
		<span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">...</span><span class="nx">limit</span><span class="p">]</span>
			<span class="nv">range_regexp = </span><span class="k">if</span> <span class="nx">i</span> <span class="o">==</span> <span class="nx">limit</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">then</span> <span class="nx">bcv_parser</span><span class="o">::</span><span class="nx">regexps</span><span class="p">.</span><span class="nx">range_and</span> <span class="k">else</span> <span class="nx">bcv_parser</span><span class="o">::</span><span class="nx">regexps</span><span class="p">.</span><span class="nx">range_only</span>
			<span class="nv">prev = </span><span class="nx">s</span><span class="p">.</span><span class="nx">match</span> <span class="err">///\b( #{cases[i-1]} \s* #{range_regexp} \s* ) \x1f #{book_id} \x1f///i</span>
			<span class="k">return</span> <span class="nx">@add_book_range_object</span><span class="p">(</span><span class="nx">passage</span><span class="p">,</span> <span class="nx">prev</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="k">if</span> <span class="nx">prev</span><span class="o">?</span>
		<span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>Create a fake object that can be parsed to show the correct result.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">add_book_range_object: </span><span class="nf">(passage, prev, start_book_number) -&gt;</span>
		<span class="nv">length = </span><span class="nx">prev</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">length</span>
		<span class="nx">passage</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
			<span class="nv">type: </span><span class="s2">&quot;b_range_pre&quot;</span>
			<span class="nv">value: </span><span class="p">[{</span><span class="nv">type: </span><span class="s2">&quot;b_pre&quot;</span><span class="p">,</span> <span class="nv">value: </span><span class="nx">start_book_number</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span> <span class="nv">indices: </span><span class="p">[</span><span class="nx">prev</span><span class="p">.</span><span class="nx">index</span><span class="p">,</span> <span class="nx">prev</span><span class="p">.</span><span class="nx">index</span> <span class="o">+</span> <span class="nx">length</span><span class="p">]},</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
			<span class="nv">indices: </span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nx">length</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>Adjust the indices of the original result so they reflect the new content</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">passage</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">value</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="nx">length</span>
		<span class="nx">passage</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">value</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="nx">length</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>These two are the most important ones; the <code>absolute_indices</code> function uses them.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">passage</span><span class="p">.</span><span class="nx">start_index</span> <span class="o">-=</span> <span class="nx">length</span>
		<span class="nv">passage.match = </span><span class="nx">prev</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">match</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <h2>Output-Related Functions</h2>

<p>Return a single OSIS string (comma-separated) for all the references in the whole input string.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">osis: </span><span class="o">-&gt;</span>
		<span class="nv">out = </span><span class="p">[]</span>
		<span class="k">for</span> <span class="nx">osis</span> <span class="k">in</span> <span class="nx">@parsed_entities</span><span class="p">()</span>
			<span class="nx">out</span><span class="p">.</span><span class="nx">push</span> <span class="nx">osis</span><span class="p">.</span><span class="nx">osis</span> <span class="k">if</span> <span class="nx">osis</span><span class="p">.</span><span class="nx">osis</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
		<span class="nx">out</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>Return an array of <code>[OSIS, TRANSLATIONS]</code> for each reference (combined according to <code>options</code>)</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">osis_and_translations: </span><span class="o">-&gt;</span>
		<span class="nv">out = </span><span class="p">[]</span>
		<span class="k">for</span> <span class="nx">osis</span> <span class="k">in</span> <span class="nx">@parsed_entities</span><span class="p">()</span>
			<span class="nx">out</span><span class="p">.</span><span class="nx">push</span> <span class="p">[</span><span class="nx">osis</span><span class="p">.</span><span class="nx">osis</span><span class="p">,</span> <span class="nx">osis</span><span class="p">.</span><span class="nx">translations</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span> <span class="k">if</span> <span class="nx">osis</span><span class="p">.</span><span class="nx">osis</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
		<span class="nx">out</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>Return an array of <code>{osis: OSIS, indices:[START, END], translations: [TRANSLATIONS]}</code> objects for each reference (combined according to <code>options</code>)</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">osis_and_indices: </span><span class="o">-&gt;</span>
		<span class="nv">out = </span><span class="p">[]</span>
		<span class="k">for</span> <span class="nx">osis</span> <span class="k">in</span> <span class="nx">@parsed_entities</span><span class="p">()</span>
			<span class="nx">out</span><span class="p">.</span><span class="nx">push</span> <span class="p">{</span><span class="nv">osis: </span><span class="nx">osis</span><span class="p">.</span><span class="nx">osis</span><span class="p">,</span> <span class="nv">translations: </span><span class="nx">osis</span><span class="p">.</span><span class="nx">translations</span><span class="p">,</span> <span class="nv">indices: </span><span class="nx">osis</span><span class="p">.</span><span class="nx">indices</span><span class="p">}</span> <span class="k">if</span> <span class="nx">osis</span><span class="p">.</span><span class="nx">osis</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
		<span class="nx">out</span></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>Return all objects, probably for additional processing.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">parsed_entities: </span><span class="o">-&gt;</span>
		<span class="nv">out = </span><span class="p">[]</span>
		<span class="k">for</span> <span class="nx">entity_id</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">@entities</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span>
			<span class="nv">entity = </span><span class="nx">@entities</span><span class="p">[</span><span class="nx">entity_id</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>Be sure to include any translation identifiers in the indices we report back, but only if the translation immediately follows the previous entity.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">type</span> <span class="o">and</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">type</span> <span class="o">is</span> <span class="s2">&quot;translation_sequence&quot;</span> <span class="o">and</span> <span class="nx">out</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">entity_id</span> <span class="o">==</span> <span class="nx">out</span><span class="p">[</span><span class="nx">out</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nx">entity_id</span> <span class="o">+</span> <span class="mi">1</span>
				<span class="nx">out</span><span class="p">[</span><span class="nx">out</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nx">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">absolute_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
			<span class="k">continue</span> <span class="nx">unless</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">passages</span><span class="o">?</span>
			<span class="k">continue</span> <span class="k">if</span> <span class="p">(</span><span class="nx">entity</span><span class="p">.</span><span class="nx">type</span> <span class="o">is</span> <span class="s2">&quot;b&quot;</span> <span class="o">or</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">type</span> <span class="o">is</span> <span class="s2">&quot;b_range&quot;</span><span class="p">)</span> <span class="o">and</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">book_alone_strategy</span> <span class="o">is</span> <span class="s2">&quot;ignore&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>A given entity, even if part of a sequence, always only has one set of translations associated with it.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nv">translations = </span><span class="p">[]</span>
			<span class="nv">translation_alias = </span><span class="kc">null</span>
			<span class="k">if</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">passages</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">translations</span><span class="o">?</span>
				<span class="k">for</span> <span class="nx">translation</span> <span class="k">in</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">passages</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">translations</span>
					<span class="nv">translation_osis = </span><span class="k">if</span> <span class="nx">translation</span><span class="p">.</span><span class="nx">osis</span><span class="o">?</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="nx">translation</span><span class="p">.</span><span class="nx">osis</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
					<span class="nx">translation_alias</span> <span class="o">?=</span> <span class="nx">translation</span><span class="p">.</span><span class="nx">alias</span>
					<span class="nx">translations</span><span class="p">.</span><span class="nx">push</span> <span class="nx">translation_osis</span>
			<span class="k">else</span>
				<span class="nv">translations = </span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span>
				<span class="nv">translation_alias = </span><span class="s2">&quot;default&quot;</span>
			<span class="nv">osises = </span><span class="p">[]</span>
			<span class="nv">length = </span><span class="nx">entity</span><span class="p">.</span><span class="nx">passages</span><span class="p">.</span><span class="nx">length</span>
			<span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">length</span><span class="p">]</span>
				<span class="nv">passage = </span><span class="nx">entity</span><span class="p">.</span><span class="nx">passages</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>The <code>type</code> is usually only set in a sequence.</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nx">passage</span><span class="p">.</span><span class="nx">type</span> <span class="o">?=</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">type</span>
				<span class="k">if</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">valid</span><span class="p">.</span><span class="nx">valid</span> <span class="o">is</span> <span class="kc">false</span>
					<span class="k">if</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">invalid_sequence_strategy</span> <span class="o">is</span> <span class="s2">&quot;ignore&quot;</span> <span class="o">and</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">type</span> <span class="o">is</span> <span class="s2">&quot;sequence&quot;</span>
						<span class="nx">@snap_sequence</span> <span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="nx">entity</span><span class="p">,</span> <span class="nx">osises</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">length</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p>Stop here if we're ignoring invalid passages.</p>             </td>             <td class="code">               <div class="highlight"><pre>					<span class="k">continue</span> <span class="k">if</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">invalid_passage_strategy</span> <span class="o">is</span> <span class="s2">&quot;ignore&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>If indicated in options, exclude stray start/end books, resetting the parent indices as needed.</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="k">if</span> <span class="p">(</span><span class="nx">passage</span><span class="p">.</span><span class="nx">type</span> <span class="o">is</span> <span class="s2">&quot;b&quot;</span> <span class="o">or</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">type</span> <span class="o">is</span> <span class="s2">&quot;b_range&quot;</span><span class="p">)</span> <span class="o">and</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">book_sequence_strategy</span> <span class="o">is</span> <span class="s2">&quot;ignore&quot;</span> <span class="o">and</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">type</span> <span class="o">is</span> <span class="s2">&quot;sequence&quot;</span>
					<span class="nx">@snap_sequence</span> <span class="s2">&quot;book&quot;</span><span class="p">,</span> <span class="nx">entity</span><span class="p">,</span> <span class="nx">osises</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">length</span>
					<span class="k">continue</span>
				<span class="nx">passage</span><span class="p">.</span><span class="nx">absolute_indices</span> <span class="o">?=</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">absolute_indices</span>
				<span class="nx">osises</span><span class="p">.</span><span class="nx">push</span>
					<span class="nv">osis: </span><span class="k">if</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">valid</span><span class="p">.</span><span class="nx">valid</span> <span class="k">then</span> <span class="nx">@to_osis</span><span class="p">(</span><span class="nx">passage</span><span class="p">.</span><span class="nx">start</span><span class="p">,</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">end</span><span class="p">,</span> <span class="nx">translation_alias</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
					<span class="nv">type: </span><span class="nx">passage</span><span class="p">.</span><span class="nx">type</span>
					<span class="nv">indices: </span><span class="nx">passage</span><span class="p">.</span><span class="nx">absolute_indices</span>
					<span class="nv">translations: </span><span class="nx">translations</span>
					<span class="nv">start: </span><span class="nx">passage</span><span class="p">.</span><span class="nx">start</span>
					<span class="nv">end: </span><span class="nx">passage</span><span class="p">.</span><span class="nx">end</span>
					<span class="nv">entity_id: </span><span class="nx">entity_id</span>
					<span class="nv">entities: </span><span class="p">[</span><span class="nx">passage</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>Don't return an empty object.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">continue</span> <span class="k">if</span> <span class="nx">osises</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span>
			<span class="nv">osises = </span><span class="nx">@combine_consecutive_passages</span> <span class="nx">osises</span><span class="p">,</span> <span class="nx">translation_alias</span> <span class="k">if</span> <span class="nx">osises</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">and</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">consecutive_combination_strategy</span> <span class="o">is</span> <span class="s2">&quot;combine&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <p>Add the osises array to the existing array.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">sequence_combination_strategy</span> <span class="o">is</span> <span class="s2">&quot;separate&quot;</span>
				<span class="nv">out = </span><span class="nx">out</span><span class="p">.</span><span class="nx">concat</span> <span class="nx">osises</span></pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <p>Add the OSIS string and some data to the array.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">else</span>
				<span class="nv">strings = </span><span class="p">[]</span>
				<span class="k">for</span> <span class="nx">osis</span> <span class="k">in</span> <span class="nx">osises</span>
					<span class="nx">strings</span><span class="p">.</span><span class="nx">push</span> <span class="nx">osis</span><span class="p">.</span><span class="nx">osis</span> <span class="k">if</span> <span class="nx">osis</span><span class="p">.</span><span class="nx">osis</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
				<span class="nx">out</span><span class="p">.</span><span class="nx">push</span> <span class="nv">osis: </span><span class="nx">strings</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">),</span> <span class="nv">indices: </span><span class="nx">entity</span><span class="p">.</span><span class="nx">absolute_indices</span><span class="p">,</span> <span class="nv">translations: </span><span class="nx">translations</span><span class="p">,</span> <span class="nv">entity_id: </span><span class="nx">entity_id</span><span class="p">,</span> <span class="nv">entities: </span><span class="nx">osises</span>
		<span class="nx">out</span>

	<span class="nv">to_osis: </span><span class="nf">(start, end, translation) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <p>If it's just a book on its own, how we deal with it depends on whether we want to return just the first chapter or the complete book.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">end.c = </span><span class="mi">1</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">end</span><span class="p">.</span><span class="nx">c</span><span class="o">?</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">end</span><span class="p">.</span><span class="nx">v</span><span class="o">?</span> <span class="o">and</span> <span class="nx">start</span><span class="p">.</span><span class="nx">b</span> <span class="o">==</span> <span class="nx">end</span><span class="p">.</span><span class="nx">b</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">start</span><span class="p">.</span><span class="nx">c</span><span class="o">?</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">start</span><span class="p">.</span><span class="nx">v</span><span class="o">?</span> <span class="o">and</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">book_alone_strategy</span> <span class="o">==</span> <span class="s2">&quot;first_chapter&quot;</span>
		<span class="nv">osis = start: </span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nv">end: </span><span class="s2">&quot;&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <p>If no start chapter or verse, assume the first possible.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">start</span><span class="p">.</span><span class="nx">c</span> <span class="o">?=</span> <span class="mi">1</span>
		<span class="nx">start</span><span class="p">.</span><span class="nx">v</span> <span class="o">?=</span> <span class="mi">1</span></pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <p>If no end chapter or verse, assume the last possible.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">end</span><span class="p">.</span><span class="nx">c</span> <span class="o">?=</span> <span class="nx">@passage</span><span class="p">.</span><span class="nx">translations</span><span class="p">[</span><span class="nx">translation</span><span class="p">].</span><span class="nx">chapters</span><span class="p">[</span><span class="nx">end</span><span class="p">.</span><span class="nx">b</span><span class="p">].</span><span class="nx">length</span>
		<span class="nx">end</span><span class="p">.</span><span class="nx">v</span> <span class="o">?=</span> <span class="nx">@passage</span><span class="p">.</span><span class="nx">translations</span><span class="p">[</span><span class="nx">translation</span><span class="p">].</span><span class="nx">chapters</span><span class="p">[</span><span class="nx">end</span><span class="p">.</span><span class="nx">b</span><span class="p">][</span><span class="nx">end</span><span class="p">.</span><span class="nx">c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <p>If it's a complete book or range of complete books and we want the shortest possible OSIS, return just the book names.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">osis_compaction_strategy</span> <span class="o">==</span> <span class="s2">&quot;b&quot;</span> <span class="o">and</span> <span class="nx">start</span><span class="p">.</span><span class="nx">c</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">and</span> <span class="nx">start</span><span class="p">.</span><span class="nx">v</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">and</span> <span class="nx">end</span><span class="p">.</span><span class="nx">c</span> <span class="o">==</span> <span class="nx">@passage</span><span class="p">.</span><span class="nx">translations</span><span class="p">[</span><span class="nx">translation</span><span class="p">].</span><span class="nx">chapters</span><span class="p">[</span><span class="nx">end</span><span class="p">.</span><span class="nx">b</span><span class="p">].</span><span class="nx">length</span> <span class="o">and</span> <span class="nx">end</span><span class="p">.</span><span class="nx">v</span> <span class="o">==</span> <span class="nx">@passage</span><span class="p">.</span><span class="nx">translations</span><span class="p">[</span><span class="nx">translation</span><span class="p">].</span><span class="nx">chapters</span><span class="p">[</span><span class="nx">end</span><span class="p">.</span><span class="nx">b</span><span class="p">][</span><span class="nx">end</span><span class="p">.</span><span class="nx">c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
			<span class="nv">osis.start = </span><span class="nx">start</span><span class="p">.</span><span class="nx">b</span>
			<span class="nv">osis.end = </span><span class="nx">end</span><span class="p">.</span><span class="nx">b</span></pre></div>             </td>           </tr>                               <tr id="section-70">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-70">&#182;</a>               </div>               <p>If it's a complete chapter or range of complete chapters and we want a short OSIS, return just the books and chapters.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">else</span> <span class="k">if</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">osis_compaction_strategy</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;=</span> <span class="mi">2</span> <span class="o">and</span> <span class="nx">start</span><span class="p">.</span><span class="nx">v</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">and</span> <span class="nx">end</span><span class="p">.</span><span class="nx">v</span> <span class="o">==</span> <span class="nx">@passage</span><span class="p">.</span><span class="nx">translations</span><span class="p">[</span><span class="nx">translation</span><span class="p">].</span><span class="nx">chapters</span><span class="p">[</span><span class="nx">end</span><span class="p">.</span><span class="nx">b</span><span class="p">][</span><span class="nx">end</span><span class="p">.</span><span class="nx">c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
			<span class="nv">osis.start = </span><span class="nx">start</span><span class="p">.</span><span class="nx">b</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="nx">start</span><span class="p">.</span><span class="nx">c</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
			<span class="nv">osis.end = </span><span class="nx">end</span><span class="p">.</span><span class="nx">b</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="nx">end</span><span class="p">.</span><span class="nx">c</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-71">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-71">&#182;</a>               </div>               <p>Otherwise, return the full BCV reference for both.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">else</span>
			<span class="nv">osis.start = </span><span class="nx">start</span><span class="p">.</span><span class="nx">b</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="nx">start</span><span class="p">.</span><span class="nx">c</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="nx">start</span><span class="p">.</span><span class="nx">v</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
			<span class="nv">osis.end = </span><span class="nx">end</span><span class="p">.</span><span class="nx">b</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="nx">end</span><span class="p">.</span><span class="nx">c</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="nx">end</span><span class="p">.</span><span class="nx">v</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-72">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-72">&#182;</a>               </div>               <p>If it's the same verse ("Gen.1.1-Gen.1.1"), chapter ("Gen.1-Gen.1") or book ("Gen-Gen"), return just the start so we don't end up with an empty range</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">return</span> <span class="nx">osis</span><span class="p">.</span><span class="nx">start</span> <span class="k">if</span> <span class="nx">osis</span><span class="p">.</span><span class="nx">start</span> <span class="o">==</span> <span class="nx">osis</span><span class="p">.</span><span class="nx">end</span></pre></div>             </td>           </tr>                               <tr id="section-73">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-73">&#182;</a>               </div>               <p>Otherwise return the range.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">osis</span><span class="p">.</span><span class="nx">start</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="nx">osis</span><span class="p">.</span><span class="nx">end</span></pre></div>             </td>           </tr>                               <tr id="section-74">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-74">&#182;</a>               </div>               <p>If we have the correct <code>option</code> set (checked before calling this function), merge passages that refer to sequential verses: Gen 1, 2 -> Gen 1-2. It works for any combination of books, chapters, and verses.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">combine_consecutive_passages: </span><span class="nf">(osises, translation) -&gt;</span>
		<span class="nv">out = </span><span class="p">[]</span>
		<span class="nv">prev = </span><span class="p">{}</span>
		<span class="k">for</span> <span class="nx">osis</span> <span class="k">in</span> <span class="nx">osises</span>
			<span class="k">if</span> <span class="nx">osis</span><span class="p">.</span><span class="nx">osis</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-75">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-75">&#182;</a>               </div>               <p>Pretend like the previous <code>end</code> and existing <code>start</code> don't exist.</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="k">if</span> <span class="nx">@is_verse_consecutive</span> <span class="nx">prev</span><span class="p">,</span> <span class="nx">osis</span><span class="p">.</span><span class="nx">start</span><span class="p">,</span> <span class="nx">translation</span>
					<span class="nv">prev_i = </span><span class="nx">out</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span>
					<span class="nx">out</span><span class="p">[</span><span class="nx">prev_i</span><span class="p">].</span><span class="nv">end = </span><span class="nx">osis</span><span class="p">.</span><span class="nx">end</span>
					<span class="nx">out</span><span class="p">[</span><span class="nx">prev_i</span><span class="p">].</span><span class="nx">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">osis</span><span class="p">.</span><span class="nx">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
					<span class="nx">out</span><span class="p">[</span><span class="nx">prev_i</span><span class="p">].</span><span class="nv">osis = </span><span class="nx">@to_osis</span> <span class="nx">out</span><span class="p">[</span><span class="nx">prev_i</span><span class="p">].</span><span class="nx">start</span><span class="p">,</span> <span class="nx">osis</span><span class="p">.</span><span class="nx">end</span><span class="p">,</span> <span class="nx">translation</span>
				<span class="k">else</span>
					<span class="nx">out</span><span class="p">.</span><span class="nx">push</span> <span class="nx">osis</span>
				<span class="nv">prev = b: </span><span class="nx">osis</span><span class="p">.</span><span class="nx">end</span><span class="p">.</span><span class="nx">b</span><span class="p">,</span> <span class="nv">c: </span><span class="nx">osis</span><span class="p">.</span><span class="nx">end</span><span class="p">.</span><span class="nx">c</span><span class="p">,</span> <span class="nv">v: </span><span class="nx">osis</span><span class="p">.</span><span class="nx">end</span><span class="p">.</span><span class="nx">v</span>
			<span class="k">else</span>
				<span class="nx">out</span><span class="p">.</span><span class="nx">push</span> <span class="nx">osis</span>
				<span class="nv">prev = </span><span class="p">{}</span>
		<span class="nx">out</span></pre></div>             </td>           </tr>                               <tr id="section-76">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-76">&#182;</a>               </div>               <p>Given two fully specified objects (complete bcvs), find whether they're sequential.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">is_verse_consecutive: </span><span class="nf">(prev, check, translation) -&gt;</span>
		<span class="k">return</span> <span class="kc">false</span> <span class="nx">unless</span> <span class="nx">prev</span><span class="p">.</span><span class="nx">b</span><span class="o">?</span>
		<span class="k">if</span> <span class="nx">prev</span><span class="p">.</span><span class="nx">b</span> <span class="o">==</span> <span class="nx">check</span><span class="p">.</span><span class="nx">b</span>
			<span class="k">if</span> <span class="nx">prev</span><span class="p">.</span><span class="nx">c</span> <span class="o">==</span> <span class="nx">check</span><span class="p">.</span><span class="nx">c</span>
				<span class="k">return</span> <span class="kc">true</span> <span class="k">if</span> <span class="nx">prev</span><span class="p">.</span><span class="nx">v</span> <span class="o">==</span> <span class="nx">check</span><span class="p">.</span><span class="nx">v</span> <span class="o">-</span> <span class="mi">1</span>
			<span class="k">else</span> <span class="k">if</span> <span class="nx">check</span><span class="p">.</span><span class="nx">v</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">and</span> <span class="nx">prev</span><span class="p">.</span><span class="nx">c</span> <span class="o">==</span> <span class="nx">check</span><span class="p">.</span><span class="nx">c</span> <span class="o">-</span> <span class="mi">1</span>
				<span class="k">return</span> <span class="kc">true</span> <span class="k">if</span> <span class="nx">prev</span><span class="p">.</span><span class="nx">v</span> <span class="o">==</span> <span class="nx">@passage</span><span class="p">.</span><span class="nx">translations</span><span class="p">[</span><span class="nx">translation</span><span class="p">].</span><span class="nx">chapters</span><span class="p">[</span><span class="nx">prev</span><span class="p">.</span><span class="nx">b</span><span class="p">][</span><span class="nx">prev</span><span class="p">.</span><span class="nx">c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
		<span class="k">else</span> <span class="k">if</span> <span class="nx">check</span><span class="p">.</span><span class="nx">c</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">and</span> <span class="nx">check</span><span class="p">.</span><span class="nx">v</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">and</span> <span class="nx">@passage</span><span class="p">.</span><span class="nx">translations</span><span class="p">[</span><span class="nx">translation</span><span class="p">].</span><span class="nx">order</span><span class="p">[</span><span class="nx">prev</span><span class="p">.</span><span class="nx">b</span><span class="p">]</span> <span class="o">==</span> <span class="nx">@passage</span><span class="p">.</span><span class="nx">translations</span><span class="p">[</span><span class="nx">translation</span><span class="p">].</span><span class="nx">order</span><span class="p">[</span><span class="nx">check</span><span class="p">.</span><span class="nx">b</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
			<span class="k">return</span> <span class="kc">true</span> <span class="k">if</span> <span class="nx">prev</span><span class="p">.</span><span class="nx">c</span> <span class="o">==</span> <span class="nx">@passage</span><span class="p">.</span><span class="nx">translations</span><span class="p">[</span><span class="nx">translation</span><span class="p">].</span><span class="nx">chapters</span><span class="p">[</span><span class="nx">prev</span><span class="p">.</span><span class="nx">b</span><span class="p">].</span><span class="nx">length</span> <span class="o">and</span> <span class="nx">prev</span><span class="p">.</span><span class="nx">v</span> <span class="o">==</span> <span class="nx">@passage</span><span class="p">.</span><span class="nx">translations</span><span class="p">[</span><span class="nx">translation</span><span class="p">].</span><span class="nx">chapters</span><span class="p">[</span><span class="nx">prev</span><span class="p">.</span><span class="nx">b</span><span class="p">][</span><span class="nx">prev</span><span class="p">.</span><span class="nx">c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
		<span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-77">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-77">&#182;</a>               </div>               <p>Snap the start/end index of the entity or surrounding passages when there's a lone book or invalid item in a sequence</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">snap_sequence: </span><span class="nf">(type, entity, osises, i, length) -&gt;</span>
		<span class="nv">passage = </span><span class="nx">entity</span><span class="p">.</span><span class="nx">passages</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-78">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-78">&#182;</a>               </div>               <p>If the passage is the first thing in the sequence and something is after it, snap the start index of the whole entity to the start index of the next item.</p>

<p>But we only want to do this if it's followed by a book (if it's "Matt, 5", we want to be sure to include "Matt" as part of the indices and bypass this step). We can tell if that's the case if the <code>type</code> of what follows starts with <code>b</code> or if it's a <code>range</code> starting in a different book. The tricky part occurs when we have several invalid references at the start (Matt 29, 30, Acts 1)--we need to find the first value that's a book. If there's a valid item before the next book, abort.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">absolute_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">absolute_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">and</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">and</span> <span class="nx">@get_snap_sequence_i</span><span class="p">(</span><span class="nx">entity</span><span class="p">.</span><span class="nx">passages</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">length</span><span class="p">)</span> <span class="o">!=</span> <span class="nx">i</span>
			<span class="nx">entity</span><span class="p">.</span><span class="nx">absolute_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">passages</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="nx">absolute_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-79">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-79">&#182;</a>               </div>               <p>If the passage is the last thing in a sequence (but not the only one), snap the entity end index to the end index of the previous valid item. To handle multiple items at the end, snap back to the last known good item if available.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">else</span> <span class="k">if</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">absolute_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">absolute_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">and</span> <span class="nx">i</span> <span class="o">&gt;</span> <span class="mi">0</span>
			<span class="nx">entity</span><span class="p">.</span><span class="nx">absolute_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="k">if</span> <span class="nx">osises</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="nx">osises</span><span class="p">[</span><span class="nx">osises</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="nx">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">passages</span><span class="p">[</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="nx">absolute_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-80">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-80">&#182;</a>               </div>               <p>Otherwise, if the next item doesn't start with a book, link the start index of the current passage to the next one because we're including the current passage as part of the next one. In "Eph. 4. Gen, Matt, 6", the <code>Matt,</code> should be part of the <code>6</code>, but "Eph. 4. Gen, Matt, 1cor6" should exclude <code>Matt</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">else</span> <span class="k">if</span> <span class="nx">type</span> <span class="o">is</span> <span class="s2">&quot;book&quot;</span> <span class="o">and</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">@starts_with_book</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">passages</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
			<span class="nx">entity</span><span class="p">.</span><span class="nx">passages</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="nx">absolute_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">absolute_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-81">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-81">&#182;</a>               </div>               <p>Return something only for unit testing</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">entity</span></pre></div>             </td>           </tr>                               <tr id="section-82">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-82">&#182;</a>               </div>               <p>Identify whether there are any valid items between the current item and the next book.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">get_snap_sequence_i: </span><span class="nf">(passages, i, length) -&gt;</span>
		<span class="k">for</span> <span class="nx">j</span> <span class="k">in</span> <span class="p">[(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)...</span><span class="nx">length</span><span class="p">]</span>
			<span class="k">return</span> <span class="nx">j</span> <span class="k">if</span> <span class="nx">@starts_with_book</span> <span class="nx">passages</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span>
			<span class="k">return</span> <span class="nx">i</span> <span class="k">if</span> <span class="nx">passages</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">valid</span><span class="p">.</span><span class="nx">valid</span>
		<span class="nx">i</span></pre></div>             </td>           </tr>                               <tr id="section-83">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-83">&#182;</a>               </div>               <p>Given a passage, does it start with a book? It never takes a sequence as an argument.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">starts_with_book: </span><span class="nf">(passage) -&gt;</span>
		<span class="k">return</span> <span class="kc">true</span> <span class="k">if</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">is</span> <span class="s2">&quot;b&quot;</span>
		<span class="k">return</span> <span class="kc">true</span> <span class="k">if</span> <span class="p">(</span><span class="nx">passage</span><span class="p">.</span><span class="nx">type</span> <span class="o">is</span> <span class="s2">&quot;range&quot;</span> <span class="o">or</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">type</span> <span class="o">is</span> <span class="s2">&quot;ff&quot;</span><span class="p">)</span> <span class="o">and</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">start</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">is</span> <span class="s2">&quot;b&quot;</span>
		<span class="kc">false</span>

<span class="nv">root.bcv_parser = </span><span class="nx">bcv_parser</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 