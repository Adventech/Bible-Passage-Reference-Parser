<!DOCTYPE html>  <html> <head>   <title>bcv_passage.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="bcv_parser.html">                 bcv_parser.coffee               </a>                                           <a class="source" href="bcv_passage.html">                 bcv_passage.coffee               </a>                                           <a class="source" href="en_regexps.html">                 en_regexps.coffee               </a>                                           <a class="source" href="en_translations.html">                 en_translations.coffee               </a>                                           <a class="source" href="es_regexps.html">                 es_regexps.coffee               </a>                                           <a class="source" href="es_translations.html">                 es_translations.coffee               </a>                                           <a class="source" href="en_spec.html">                 en_spec.coffee               </a>                                           <a class="source" href="es_spec.html">                 es_spec.coffee               </a>                                           <a class="source" href="eu_es_spec.html">                 eu_es_spec.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               bcv_passage.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>This class takes the output from the grammar and turns it into simpler objects for additional processing or for output.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">bcv_passage</span>
	<span class="nv">books: </span><span class="p">[]</span>
	<span class="nv">indices: </span><span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p><code>bcv_parser</code> sets these two.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">options: </span><span class="p">{}</span>
	<span class="nv">translations: </span><span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h2>Public</h2>

<p>Loop through the parsed passages.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">handle_array: </span><span class="nf">(passages, accum=[], context={}) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p><code>passages</code> is an array of passage objects.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">for</span> <span class="nx">passage</span> <span class="k">in</span> <span class="nx">passages</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Each <code>passage</code> consists of passage objects and, possibly, strings.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="p">[</span><span class="nx">accum</span><span class="p">,</span> <span class="nx">context</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@handle_obj</span> <span class="nx">passage</span><span class="p">,</span> <span class="nx">accum</span><span class="p">,</span> <span class="nx">context</span>
		<span class="p">[</span><span class="nx">accum</span><span class="p">,</span> <span class="nx">context</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Handle a typical passage object with an <code>index</code>, <code>type</code>, and array in <code>value</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">handle_obj: </span><span class="nf">(passage, accum, context) -&gt;</span>
		<span class="k">if</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">type</span><span class="o">?</span> <span class="o">and</span> <span class="err">@</span><span class="p">[</span><span class="nx">passage</span><span class="p">.</span><span class="nx">type</span><span class="p">]</span><span class="o">?</span>
			<span class="err">@</span><span class="p">[</span><span class="nx">passage</span><span class="p">.</span><span class="nx">type</span><span class="p">]</span> <span class="nx">passage</span><span class="p">,</span> <span class="nx">accum</span><span class="p">,</span> <span class="nx">context</span>
		<span class="k">else</span> <span class="p">[</span><span class="nx">accum</span><span class="p">,</span> <span class="nx">context</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <h2>Types Returned from the Grammar</h2>

<p>These functions correspond to <code>type</code> attributes returned from the grammar. They're designed to be called multiple times if necessary.</p>

<p>Handle a book on its own.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">b: </span><span class="nf">(passage, accum, context) -&gt;</span>
		<span class="nv">passage.start_context = </span><span class="nx">@shallow_clone</span> <span class="nx">context</span>
		<span class="nv">passage.passages = </span><span class="p">[]</span>
		<span class="nv">alternates = </span><span class="p">[]</span>
		<span class="k">for</span> <span class="nx">b</span> <span class="k">in</span> <span class="nx">@books</span><span class="p">[</span><span class="nx">passage</span><span class="p">.</span><span class="nx">value</span><span class="p">].</span><span class="nx">parsed</span>
			<span class="nv">valid = </span><span class="nx">@validate_ref</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">start_context</span><span class="p">.</span><span class="nx">translations</span><span class="p">,</span> <span class="p">{</span><span class="nv">b: </span><span class="nx">b</span><span class="p">}</span>
			<span class="nv">obj = start: </span><span class="p">{</span><span class="nv">b: </span><span class="nx">b</span><span class="p">},</span> <span class="nv">end: </span><span class="p">{</span><span class="nv">b: </span><span class="nx">b</span><span class="p">},</span> <span class="nv">valid: </span><span class="nx">valid</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Use the first valid book.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">passages</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">valid</span><span class="p">.</span><span class="nx">valid</span>
				<span class="nx">passage</span><span class="p">.</span><span class="nx">passages</span><span class="p">.</span><span class="nx">push</span> <span class="nx">obj</span>
			<span class="k">else</span>
				<span class="nx">alternates</span><span class="p">.</span><span class="nx">push</span> <span class="nx">obj</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>If none are valid, use the first one.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">passage</span><span class="p">.</span><span class="nx">passages</span><span class="p">.</span><span class="nx">push</span> <span class="nx">alternates</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span> <span class="k">if</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">passages</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span>
		<span class="nx">passage</span><span class="p">.</span><span class="nx">passages</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nv">alternates = </span><span class="nx">alternates</span> <span class="k">if</span> <span class="nx">alternates</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
		<span class="nx">passage</span><span class="p">.</span><span class="nx">passages</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nv">translations = </span><span class="nx">passage</span><span class="p">.</span><span class="nx">start_context</span><span class="p">.</span><span class="nx">translations</span> <span class="k">if</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">start_context</span><span class="p">.</span><span class="nx">translations</span><span class="o">?</span>
		<span class="nx">passage</span><span class="p">.</span><span class="nx">absolute_indices</span> <span class="o">?=</span> <span class="nx">@get_absolute_indices</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">indices</span>
		<span class="nx">accum</span><span class="p">.</span><span class="nx">push</span> <span class="nx">passage</span>
		<span class="nv">context = b: </span><span class="nx">passage</span><span class="p">.</span><span class="nx">passages</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">start</span><span class="p">.</span><span class="nx">b</span>
		<span class="nv">context.translations = </span><span class="nx">passage</span><span class="p">.</span><span class="nx">start_context</span><span class="p">.</span><span class="nx">translations</span> <span class="k">if</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">start_context</span><span class="p">.</span><span class="nx">translations</span><span class="o">?</span>
		<span class="p">[</span><span class="nx">accum</span><span class="p">,</span> <span class="nx">context</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Handle book-only ranges.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">b_range: </span><span class="nf">(passage, accum, context) -&gt;</span>
		<span class="nx">@range</span> <span class="nx">passage</span><span class="p">,</span> <span class="nx">accum</span><span class="p">,</span> <span class="nx">context</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Handle book-only ranges like 1-2 Samuel. It doesn't support multiple ambiguous ranges (like <code>1-2C</code>), which it probably shouldn't, anyway</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">b_range_pre: </span><span class="nf">(passage, accum, context) -&gt;</span>
		<span class="nv">passage.start_context = </span><span class="nx">@shallow_clone</span> <span class="nx">context</span>
		<span class="nv">passage.passages = </span><span class="p">[]</span>
		<span class="nv">alternates = </span><span class="p">[]</span>
		<span class="nv">book = </span><span class="nx">@pluck</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">value</span>
		<span class="p">[[</span><span class="nx">end</span><span class="p">],</span> <span class="nx">context</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@b</span> <span class="nx">book</span><span class="p">,</span> <span class="p">[],</span> <span class="nx">context</span>
		<span class="nx">passage</span><span class="p">.</span><span class="nx">absolute_indices</span> <span class="o">?=</span> <span class="nx">@get_absolute_indices</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">indices</span>
		<span class="nv">start_obj = b: </span><span class="nx">passage</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">value</span> <span class="o">+</span> <span class="nx">end</span><span class="p">.</span><span class="nx">passages</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">start</span><span class="p">.</span><span class="nx">b</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="nv">type: </span><span class="s2">&quot;b&quot;</span>
		<span class="nv">passage.passages = </span><span class="p">[</span><span class="nv">start: </span><span class="nx">start_obj</span><span class="p">,</span> <span class="nv">end: </span><span class="nx">end</span><span class="p">.</span><span class="nx">passages</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">end</span><span class="p">,</span> <span class="nv">valid: </span><span class="nx">end</span><span class="p">.</span><span class="nx">passages</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">valid</span><span class="p">]</span>
		<span class="nx">passage</span><span class="p">.</span><span class="nx">passages</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nv">translations = </span><span class="nx">passage</span><span class="p">.</span><span class="nx">start_context</span><span class="p">.</span><span class="nx">translations</span> <span class="k">if</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">start_context</span><span class="p">.</span><span class="nx">translations</span><span class="o">?</span>
		<span class="nx">accum</span><span class="p">.</span><span class="nx">push</span> <span class="nx">passage</span>
		<span class="p">[</span><span class="nx">accum</span><span class="p">,</span> <span class="nx">context</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>The base (root) object in the grammar and controls the base indices.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">base: </span><span class="nf">(passage, accum, context) -&gt;</span>
		<span class="vi">@indices = </span><span class="nx">@calculate_indices</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">match</span><span class="p">,</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">start_index</span>
		<span class="nx">@handle_array</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="nx">accum</span><span class="p">,</span> <span class="nx">context</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Handle book-chapter.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">bc: </span><span class="nf">(passage, accum, context) -&gt;</span>
		<span class="nv">passage.start_context = </span><span class="nx">@shallow_clone</span> <span class="nx">context</span>
		<span class="nv">passage.passages = </span><span class="p">[]</span>
		<span class="k">for</span> <span class="nx">type</span> <span class="k">in</span> <span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="s2">&quot;v&quot;</span><span class="p">]</span>
			<span class="k">delete</span> <span class="nx">context</span><span class="p">[</span><span class="nx">type</span><span class="p">]</span>
		<span class="nv">c = </span><span class="nx">@pluck</span><span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">value</span><span class="p">).</span><span class="nx">value</span>
		<span class="nv">alternates = </span><span class="p">[]</span>
		<span class="k">for</span> <span class="nx">b</span> <span class="k">in</span> <span class="nx">@books</span><span class="p">[</span><span class="nx">@pluck</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">value</span><span class="p">).</span><span class="nx">value</span><span class="p">].</span><span class="nx">parsed</span>
			<span class="nv">context_key = </span><span class="s2">&quot;c&quot;</span>
			<span class="nv">valid = </span><span class="nx">@validate_ref</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">start_context</span><span class="p">.</span><span class="nx">translations</span><span class="p">,</span> <span class="p">{</span><span class="nv">b: </span><span class="nx">b</span><span class="p">,</span> <span class="nv">c: </span><span class="nx">c</span><span class="p">}</span>
			<span class="nv">obj = start: </span><span class="p">{</span><span class="nv">b: </span><span class="nx">b</span><span class="p">},</span> <span class="nv">end: </span><span class="p">{</span><span class="nv">b: </span><span class="nx">b</span><span class="p">},</span> <span class="nv">valid: </span><span class="nx">valid</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Is it really a <code>bv</code> object?</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span> <span class="nx">valid</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">start_chapter_not_exist_in_single_chapter_book</span>
				<span class="nv">obj.valid = </span><span class="nx">@validate_ref</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">start_context</span><span class="p">.</span><span class="nx">translations</span><span class="p">,</span> <span class="p">{</span><span class="nv">b: </span><span class="nx">b</span><span class="p">,</span> <span class="nv">v: </span><span class="nx">c</span><span class="p">}</span>
				<span class="nv">obj.start.c = </span><span class="mi">1</span>
				<span class="nv">obj.end.c = </span><span class="mi">1</span>
				<span class="nv">context_key = </span><span class="s2">&quot;v&quot;</span>
			<span class="nx">obj</span><span class="p">.</span><span class="nx">start</span><span class="p">[</span><span class="nx">context_key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">c</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>If it's zero, fix it before assigning the end.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="p">[</span><span class="nx">obj</span><span class="p">.</span><span class="nx">start</span><span class="p">.</span><span class="nx">c</span><span class="p">,</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">start</span><span class="p">.</span><span class="nx">v</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@fix_start_zeroes</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">valid</span><span class="p">,</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">start</span><span class="p">.</span><span class="nx">c</span><span class="p">,</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">start</span><span class="p">.</span><span class="nx">v</span>
			<span class="nx">obj</span><span class="p">.</span><span class="nx">end</span><span class="p">[</span><span class="nx">context_key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">start</span><span class="p">[</span><span class="nx">context_key</span><span class="p">]</span>
			<span class="k">if</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">passages</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">valid</span><span class="p">.</span><span class="nx">valid</span>
				<span class="nx">passage</span><span class="p">.</span><span class="nx">passages</span><span class="p">.</span><span class="nx">push</span> <span class="nx">obj</span>
			<span class="k">else</span>
				<span class="nx">alternates</span><span class="p">.</span><span class="nx">push</span> <span class="nx">obj</span>
		<span class="nx">passage</span><span class="p">.</span><span class="nx">passages</span><span class="p">.</span><span class="nx">push</span> <span class="nx">alternates</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span> <span class="k">if</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">passages</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span>
		<span class="nx">passage</span><span class="p">.</span><span class="nx">passages</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nv">alternates = </span><span class="nx">alternates</span> <span class="k">if</span> <span class="nx">alternates</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
		<span class="nx">passage</span><span class="p">.</span><span class="nx">passages</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nv">translations = </span><span class="nx">passage</span><span class="p">.</span><span class="nx">start_context</span><span class="p">.</span><span class="nx">translations</span> <span class="k">if</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">start_context</span><span class="p">.</span><span class="nx">translations</span><span class="o">?</span>
		<span class="nx">passage</span><span class="p">.</span><span class="nx">absolute_indices</span> <span class="o">?=</span> <span class="nx">@get_absolute_indices</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">indices</span>
		<span class="k">for</span> <span class="nx">type</span> <span class="k">in</span> <span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="s2">&quot;v&quot;</span><span class="p">]</span>
			<span class="nx">context</span><span class="p">[</span><span class="nx">type</span><span class="p">]</span> <span class="o">=</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">passages</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">start</span><span class="p">[</span><span class="nx">type</span><span class="p">]</span> <span class="k">if</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">passages</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">start</span><span class="p">[</span><span class="nx">type</span><span class="p">]</span><span class="o">?</span>
		<span class="nx">accum</span><span class="p">.</span><span class="nx">push</span> <span class="nx">passage</span>
		<span class="p">[</span><span class="nx">accum</span><span class="p">,</span> <span class="nx">context</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Handle "Ps 3 title"</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">bc_title: </span><span class="nf">(passage, accum, context) -&gt;</span>
		<span class="nv">passage.start_context = </span><span class="nx">@shallow_clone</span> <span class="nx">context</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>First, check to see whether we're dealing with Psalms. If not, treat it as a straight <code>bc</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="p">[[</span><span class="nx">bc</span><span class="p">],</span> <span class="nx">context</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@bc</span> <span class="nx">@pluck</span><span class="p">(</span><span class="s2">&quot;bc&quot;</span><span class="p">,</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">value</span><span class="p">),</span> <span class="p">[],</span> <span class="nx">context</span>
		<span class="k">if</span> <span class="nx">bc</span><span class="p">.</span><span class="nx">passages</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">start</span><span class="p">.</span><span class="nx">b</span> <span class="o">isnt</span> <span class="s2">&quot;Ps&quot;</span> <span class="o">and</span> <span class="nx">bc</span><span class="p">.</span><span class="nx">passages</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">alternates</span><span class="o">?</span>
			<span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">bc</span><span class="p">.</span><span class="nx">passages</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">alternates</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span>
				<span class="k">continue</span> <span class="nx">unless</span> <span class="nx">bc</span><span class="p">.</span><span class="nx">passages</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">alternates</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">start</span><span class="p">.</span><span class="nx">b</span> <span class="o">is</span> <span class="s2">&quot;Ps&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>If Psalms is one of the alternates, promote it to the primary passage and discard the others--we know it's right.</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nx">bc</span><span class="p">.</span><span class="nx">passages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">bc</span><span class="p">.</span><span class="nx">passages</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">alternates</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
				<span class="k">break</span>
		<span class="k">if</span> <span class="nx">bc</span><span class="p">.</span><span class="nx">passages</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">start</span><span class="p">.</span><span class="nx">b</span> <span class="o">isnt</span> <span class="s2">&quot;Ps&quot;</span>
			<span class="nx">accum</span><span class="p">.</span><span class="nx">push</span> <span class="nx">bc</span>
			<span class="k">return</span> <span class="p">[</span><span class="nx">accum</span><span class="p">,</span> <span class="nx">context</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Overwrite all the other book possibilities; the presence of "title" indicates a Psalm</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">@books</span><span class="p">[</span><span class="nx">@pluck</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="nx">bc</span><span class="p">.</span><span class="nx">value</span><span class="p">).</span><span class="nx">value</span><span class="p">].</span><span class="nv">parsed = </span><span class="p">[</span><span class="s2">&quot;Ps&quot;</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Set the <code>indices</code> of the new <code>v</code> object to the indices of the <code>title</code>. We won't actually use these indices anywhere.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">title = </span><span class="nx">@pluck</span> <span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">value</span>
		<span class="nx">passage</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nv">type: </span><span class="s2">&quot;v&quot;</span><span class="p">,</span> <span class="nv">value: </span><span class="p">[{</span><span class="nv">type: </span><span class="s2">&quot;integer&quot;</span><span class="p">,</span> <span class="nv">value: </span><span class="mi">1</span><span class="p">,</span> <span class="nv">indices: </span><span class="nx">title</span><span class="p">.</span><span class="nx">indices</span><span class="p">}],</span> <span class="nv">indices: </span><span class="nx">title</span><span class="p">.</span><span class="nx">indices</span><span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Not for reparsing but in case we're curious later.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">passage.original_type = </span><span class="s2">&quot;bc_title&quot;</span>
		<span class="nv">passage.type = </span><span class="s2">&quot;bcv&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Treat it as a standard <code>bcv</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">@bcv</span> <span class="nx">passage</span><span class="p">,</span> <span class="nx">accum</span><span class="p">,</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">start_context</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Handle book chapter:verse.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">bcv: </span><span class="nf">(passage, accum, context) -&gt;</span>
		<span class="nv">passage.start_context = </span><span class="nx">@shallow_clone</span> <span class="nx">context</span>
		<span class="nv">passage.passages = </span><span class="p">[]</span>
		<span class="k">for</span> <span class="nx">type</span> <span class="k">in</span> <span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="s2">&quot;v&quot;</span><span class="p">]</span>
			<span class="k">delete</span> <span class="nx">context</span><span class="p">[</span><span class="nx">type</span><span class="p">]</span>
		<span class="nv">bc = </span><span class="nx">@pluck</span> <span class="s2">&quot;bc&quot;</span><span class="p">,</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">value</span>
		<span class="nv">c = </span><span class="nx">@pluck</span><span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="nx">bc</span><span class="p">.</span><span class="nx">value</span><span class="p">).</span><span class="nx">value</span>
		<span class="nv">v = </span><span class="nx">@pluck</span><span class="p">(</span><span class="s2">&quot;v&quot;</span><span class="p">,</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">value</span><span class="p">).</span><span class="nx">value</span>
		<span class="nv">alternates = </span><span class="p">[]</span>
		<span class="k">for</span> <span class="nx">b</span> <span class="k">in</span> <span class="nx">@books</span><span class="p">[</span><span class="nx">@pluck</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="nx">bc</span><span class="p">.</span><span class="nx">value</span><span class="p">).</span><span class="nx">value</span><span class="p">].</span><span class="nx">parsed</span>
			<span class="nv">valid = </span><span class="nx">@validate_ref</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">start_context</span><span class="p">.</span><span class="nx">translations</span><span class="p">,</span> <span class="p">{</span><span class="nv">b: </span><span class="nx">b</span><span class="p">,</span> <span class="nv">c: </span><span class="nx">c</span><span class="p">,</span> <span class="nv">v: </span><span class="nx">v</span><span class="p">}</span>
			<span class="p">[</span><span class="nx">c</span><span class="p">,</span> <span class="nx">v</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@fix_start_zeroes</span> <span class="nx">valid</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">v</span>
			<span class="nv">obj = start: </span><span class="p">{</span><span class="nv">b: </span><span class="nx">b</span><span class="p">,</span> <span class="nv">c: </span><span class="nx">c</span><span class="p">,</span> <span class="nv">v: </span><span class="nx">v</span><span class="p">},</span> <span class="nv">end: </span><span class="p">{</span><span class="nv">b: </span><span class="nx">b</span><span class="p">,</span> <span class="nv">c: </span><span class="nx">c</span><span class="p">,</span> <span class="nv">v: </span><span class="nx">v</span><span class="p">},</span> <span class="nv">valid: </span><span class="nx">valid</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Use the first valid option.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">passages</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">valid</span><span class="p">.</span><span class="nx">valid</span>
				<span class="nx">passage</span><span class="p">.</span><span class="nx">passages</span><span class="p">.</span><span class="nx">push</span> <span class="nx">obj</span>
			<span class="k">else</span>
				<span class="nx">alternates</span><span class="p">.</span><span class="nx">push</span> <span class="nx">obj</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>If there are no valid options, use the first one.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">passage</span><span class="p">.</span><span class="nx">passages</span><span class="p">.</span><span class="nx">push</span> <span class="nx">alternates</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span> <span class="k">if</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">passages</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span>
		<span class="nx">passage</span><span class="p">.</span><span class="nx">passages</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nv">alternates = </span><span class="nx">alternates</span> <span class="k">if</span> <span class="nx">alternates</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
		<span class="nx">passage</span><span class="p">.</span><span class="nx">passages</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nv">translations = </span><span class="nx">passage</span><span class="p">.</span><span class="nx">start_context</span><span class="p">.</span><span class="nx">translations</span> <span class="k">if</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">start_context</span><span class="p">.</span><span class="nx">translations</span><span class="o">?</span>
		<span class="nx">passage</span><span class="p">.</span><span class="nx">absolute_indices</span> <span class="o">?=</span> <span class="nx">@get_absolute_indices</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">indices</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Set all the available context keys.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">for</span> <span class="nx">type</span> <span class="k">in</span> <span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="s2">&quot;v&quot;</span><span class="p">]</span>
			<span class="nx">context</span><span class="p">[</span><span class="nx">type</span><span class="p">]</span> <span class="o">=</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">passages</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">start</span><span class="p">[</span><span class="nx">type</span><span class="p">]</span> <span class="k">if</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">passages</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">start</span><span class="p">[</span><span class="nx">type</span><span class="p">]</span><span class="o">?</span>
		<span class="nx">accum</span><span class="p">.</span><span class="nx">push</span> <span class="nx">passage</span>
		<span class="p">[</span><span class="nx">accum</span><span class="p">,</span> <span class="nx">context</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Handle "Philemon verse 6." This is unusual.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">bv: </span><span class="nf">(passage, accum, context) -&gt;</span>
		<span class="nv">passage.start_context = </span><span class="nx">@shallow_clone</span> <span class="nx">context</span>
		<span class="p">[</span><span class="nx">b</span><span class="p">,</span> <span class="nx">v</span><span class="p">]</span> <span class="o">=</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">value</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Construct a virtual BCV object with a chapter of 1.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">bcv =</span>
			<span class="nv">indices: </span><span class="nx">passage</span><span class="p">.</span><span class="nx">indices</span>
			<span class="nv">value: </span><span class="p">[</span>
				<span class="p">{</span><span class="nv">type: </span><span class="s2">&quot;bc&quot;</span><span class="p">,</span> <span class="nv">value: </span><span class="p">[</span><span class="nx">b</span><span class="p">,</span> <span class="p">{</span><span class="nv">type: </span><span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="nv">value: </span><span class="p">[{</span><span class="nv">type: </span><span class="s2">&quot;integer&quot;</span><span class="p">,</span> <span class="nv">value: </span><span class="mi">1</span><span class="p">}]}]}</span>
				<span class="nx">v</span>
			<span class="p">]</span>
		<span class="p">[[</span><span class="nx">bcv</span><span class="p">],</span> <span class="nx">context</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@bcv</span> <span class="nx">bcv</span><span class="p">,</span> <span class="p">[],</span> <span class="nx">context</span>
		<span class="nv">passage.passages = </span><span class="nx">bcv</span><span class="p">.</span><span class="nx">passages</span>
		<span class="nx">passage</span><span class="p">.</span><span class="nx">passages</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nv">translations = </span><span class="nx">passage</span><span class="p">.</span><span class="nx">start_context</span><span class="p">.</span><span class="nx">translations</span> <span class="k">if</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">start_context</span><span class="p">.</span><span class="nx">translations</span><span class="o">?</span>
		<span class="nx">passage</span><span class="p">.</span><span class="nx">absolute_indices</span> <span class="o">?=</span> <span class="nx">@get_absolute_indices</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">indices</span>
		<span class="nx">accum</span><span class="p">.</span><span class="nx">push</span> <span class="nx">passage</span>
		<span class="p">[</span><span class="nx">accum</span><span class="p">,</span> <span class="nx">context</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Handle a chapter.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">c: </span><span class="nf">(passage, accum, context) -&gt;</span>
		<span class="nv">passage.start_context = </span><span class="nx">@shallow_clone</span> <span class="nx">context</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>If it's an actual chapter object, the value we want is in the integer object inside it.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">c = </span><span class="k">if</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">type</span> <span class="o">is</span> <span class="s2">&quot;integer&quot;</span> <span class="k">then</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">value</span> <span class="k">else</span> <span class="nx">@pluck</span><span class="p">(</span><span class="s2">&quot;integer&quot;</span><span class="p">,</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">value</span><span class="p">).</span><span class="nx">value</span>
		<span class="nv">valid = </span><span class="nx">@validate_ref</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">start_context</span><span class="p">.</span><span class="nx">translations</span><span class="p">,</span> <span class="p">{</span><span class="nv">b: </span><span class="nx">context</span><span class="p">.</span><span class="nx">b</span><span class="p">,</span> <span class="nv">c: </span><span class="nx">c</span><span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>If it's a single-chapter book, then treat it as a verse even if it looks like a chapter (unless its value is <code>1</code>).</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span> <span class="o">not</span> <span class="nx">valid</span><span class="p">.</span><span class="nx">valid</span> <span class="o">and</span> <span class="nx">valid</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">start_chapter_not_exist_in_single_chapter_book</span>
			<span class="k">return</span> <span class="nx">@v</span> <span class="nx">passage</span><span class="p">,</span> <span class="nx">accum</span><span class="p">,</span> <span class="nx">context</span>
		<span class="p">[</span><span class="nx">c</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@fix_start_zeroes</span> <span class="nx">valid</span><span class="p">,</span> <span class="nx">c</span>
		<span class="nv">passage.passages = </span><span class="p">[</span><span class="nv">start: </span><span class="p">{</span><span class="nv">b: </span><span class="nx">context</span><span class="p">.</span><span class="nx">b</span><span class="p">,</span> <span class="nv">c: </span><span class="nx">c</span><span class="p">},</span> <span class="nv">end: </span><span class="p">{</span><span class="nv">b: </span><span class="nx">context</span><span class="p">.</span><span class="nx">b</span><span class="p">,</span> <span class="nv">c: </span><span class="nx">c</span><span class="p">},</span> <span class="nv">valid: </span><span class="nx">valid</span><span class="p">]</span>
		<span class="nx">passage</span><span class="p">.</span><span class="nx">passages</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nv">translations = </span><span class="nx">passage</span><span class="p">.</span><span class="nx">start_context</span><span class="p">.</span><span class="nx">translations</span> <span class="k">if</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">start_context</span><span class="p">.</span><span class="nx">translations</span><span class="o">?</span>
		<span class="nx">accum</span><span class="p">.</span><span class="nx">push</span> <span class="nx">passage</span>
		<span class="nv">context.c = </span><span class="nx">c</span>
		<span class="k">delete</span> <span class="nx">context</span><span class="p">.</span><span class="nx">v</span>
		<span class="nx">passage</span><span class="p">.</span><span class="nx">absolute_indices</span> <span class="o">?=</span> <span class="nx">@get_absolute_indices</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">indices</span>
		<span class="p">[</span><span class="nx">accum</span><span class="p">,</span> <span class="nx">context</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Handle "23rd Psalm" by recasting it as a <code>bc</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">c_psalm: </span><span class="nf">(passage, accum, context) -&gt;</span>
		<span class="nv">passage.original_type = </span><span class="nx">passage</span><span class="p">.</span><span class="nx">type</span>
		<span class="nv">passage.original_value = </span><span class="nx">passage</span><span class="p">.</span><span class="nx">value</span>
		<span class="nv">passage.type = </span><span class="s2">&quot;bc&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>This string always starts with the chapter number, followed by other letters.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">c = </span><span class="nx">@books</span><span class="p">[</span><span class="nx">passage</span><span class="p">.</span><span class="nx">value</span><span class="p">].</span><span class="nx">value</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^\d+/</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
		<span class="nv">passage.value = </span><span class="p">[</span>
			<span class="p">{</span><span class="nv">type: </span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="nv">value: </span><span class="nx">passage</span><span class="p">.</span><span class="nx">original_value</span><span class="p">,</span> <span class="nv">indices: </span><span class="nx">passage</span><span class="p">.</span><span class="nx">indices</span><span class="p">}</span>
			<span class="p">{</span><span class="nv">type: </span><span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="nv">value: </span><span class="p">[{</span><span class="nv">type: </span><span class="s2">&quot;integer&quot;</span><span class="p">,</span> <span class="nv">value: </span><span class="nx">c</span><span class="p">,</span> <span class="nv">indices: </span><span class="nx">passage</span><span class="p">.</span><span class="nx">indices</span><span class="p">}],</span> <span class="nv">indices: </span><span class="nx">passage</span><span class="p">.</span><span class="nx">indices</span><span class="p">}</span>
		<span class="p">]</span>
		<span class="nx">@bc</span> <span class="nx">passage</span><span class="p">,</span> <span class="nx">accum</span><span class="p">,</span> <span class="nx">context</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Handle "Ps 3, ch 4:title"</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">c_title: </span><span class="nf">(passage, accum, context) -&gt;</span>
		<span class="nv">passage.start_context = </span><span class="nx">@shallow_clone</span> <span class="nx">context</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>If it's not a Psalm, treat it as a regular chapter</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span> <span class="nx">context</span><span class="p">.</span><span class="nx">b</span> <span class="o">isnt</span> <span class="s2">&quot;Ps&quot;</span>
			<span class="k">return</span> <span class="nx">@c</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">accum</span><span class="p">,</span> <span class="nx">context</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>Add a <code>v</code> object and treat it as a refular <code>cv</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">title = </span><span class="nx">@pluck</span> <span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">value</span>
		<span class="nx">passage</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nv">type: </span><span class="s2">&quot;v&quot;</span><span class="p">,</span> <span class="nv">value: </span><span class="p">[{</span><span class="nv">type: </span><span class="s2">&quot;integer&quot;</span><span class="p">,</span> <span class="nv">value: </span><span class="mi">1</span><span class="p">,</span> <span class="nv">indices: </span><span class="nx">title</span><span class="p">.</span><span class="nx">indices</span><span class="p">}],</span> <span class="nv">indices: </span><span class="nx">title</span><span class="p">.</span><span class="nx">indices</span><span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Not for reparsing but in case we're curious later.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">passage.original_type = </span><span class="s2">&quot;c_title&quot;</span>
		<span class="nv">passage.type = </span><span class="s2">&quot;cv&quot;</span>
		<span class="nx">@cv</span> <span class="nx">passage</span><span class="p">,</span> <span class="nx">accum</span><span class="p">,</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">start_context</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>Handle a chapter:verse.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">cv: </span><span class="nf">(passage, accum, context) -&gt;</span>
		<span class="nv">passage.start_context = </span><span class="nx">@shallow_clone</span> <span class="nx">context</span>
		<span class="nv">c = </span><span class="nx">@pluck</span><span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">value</span><span class="p">).</span><span class="nx">value</span>
		<span class="nv">v = </span><span class="nx">@pluck</span><span class="p">(</span><span class="s2">&quot;v&quot;</span><span class="p">,</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">value</span><span class="p">).</span><span class="nx">value</span>
		<span class="nv">valid = </span><span class="nx">@validate_ref</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">start_context</span><span class="p">.</span><span class="nx">translations</span><span class="p">,</span> <span class="p">{</span><span class="nv">b: </span><span class="nx">context</span><span class="p">.</span><span class="nx">b</span><span class="p">,</span> <span class="nv">c: </span><span class="nx">c</span><span class="p">,</span> <span class="nv">v: </span><span class="nx">v</span><span class="p">}</span>
		<span class="p">[</span><span class="nx">c</span><span class="p">,</span> <span class="nx">v</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@fix_start_zeroes</span> <span class="nx">valid</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">v</span>
		<span class="nv">passage.passages = </span><span class="p">[</span><span class="nv">start: </span><span class="p">{</span><span class="nv">b: </span><span class="nx">context</span><span class="p">.</span><span class="nx">b</span><span class="p">,</span> <span class="nv">c: </span><span class="nx">c</span><span class="p">,</span> <span class="nv">v: </span><span class="nx">v</span><span class="p">},</span> <span class="nv">end: </span><span class="p">{</span><span class="nv">b: </span><span class="nx">context</span><span class="p">.</span><span class="nx">b</span><span class="p">,</span> <span class="nv">c: </span><span class="nx">c</span><span class="p">,</span> <span class="nv">v: </span><span class="nx">v</span><span class="p">},</span> <span class="nv">valid: </span><span class="nx">valid</span><span class="p">]</span>
		<span class="nx">passage</span><span class="p">.</span><span class="nx">passages</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nv">translations = </span><span class="nx">passage</span><span class="p">.</span><span class="nx">start_context</span><span class="p">.</span><span class="nx">translations</span> <span class="k">if</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">start_context</span><span class="p">.</span><span class="nx">translations</span><span class="o">?</span>
		<span class="nx">accum</span><span class="p">.</span><span class="nx">push</span> <span class="nx">passage</span>
		<span class="nv">context.c = </span><span class="nx">c</span>
		<span class="nv">context.v = </span><span class="nx">v</span>
		<span class="nx">passage</span><span class="p">.</span><span class="nx">absolute_indices</span> <span class="o">?=</span> <span class="nx">@get_absolute_indices</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">indices</span>
		<span class="p">[</span><span class="nx">accum</span><span class="p">,</span> <span class="nx">context</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>Handle "Chapters 1-2 from Daniel".</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">cb_range: </span><span class="nf">(passage, accum, context) -&gt;</span>
		<span class="nv">passage.original_type = </span><span class="nx">passage</span><span class="p">.</span><span class="nx">type</span>
		<span class="nv">passage.type = </span><span class="s2">&quot;range&quot;</span>
		<span class="p">[</span><span class="nx">b</span><span class="p">,</span> <span class="nx">start_c</span><span class="p">,</span> <span class="nx">end_c</span><span class="p">]</span> <span class="o">=</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">value</span>
		<span class="nv">passage.original_value = </span><span class="p">[</span><span class="nx">b</span><span class="p">,</span> <span class="nx">start_c</span><span class="p">,</span> <span class="nx">end_c</span><span class="p">]</span>
		<span class="nv">passage.value = </span><span class="p">[{</span><span class="nv">type: </span><span class="s2">&quot;bc&quot;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span><span class="p">[</span><span class="nx">b</span><span class="p">,</span> <span class="nx">start_c</span><span class="p">],</span> <span class="nv">indices: </span><span class="nx">passage</span><span class="p">.</span><span class="nx">indices</span><span class="p">},</span> <span class="nx">end_c</span><span class="p">]</span>
		<span class="nx">end_c</span><span class="p">.</span><span class="nx">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
		<span class="nx">@range</span> <span class="nx">passage</span><span class="p">,</span> <span class="nx">accum</span><span class="p">,</span> <span class="nx">context</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>Handle "23rd Psalm verse 1" by recasting it as a <code>bcv</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">cv_psalm: </span><span class="nf">(passage, accum, context) -&gt;</span>
		<span class="nv">passage.start_context = </span><span class="nx">@shallow_clone</span> <span class="nx">context</span>
		<span class="nv">passage.original_type = </span><span class="nx">passage</span><span class="p">.</span><span class="nx">type</span>
		<span class="nv">passage.original_value = </span><span class="nx">passage</span><span class="p">.</span><span class="nx">value</span>
		<span class="p">[</span><span class="nx">c_psalm</span><span class="p">,</span> <span class="nx">v</span><span class="p">]</span> <span class="o">=</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">value</span>
		<span class="nv">passage.type = </span><span class="s2">&quot;bcv&quot;</span>
		<span class="p">[[</span><span class="nx">bc</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">@c_psalm</span> <span class="nx">c_psalm</span><span class="p">,</span> <span class="p">[],</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">start_context</span>
		<span class="nv">passage.value = </span><span class="p">[</span><span class="nx">bc</span><span class="p">,</span> <span class="nx">v</span><span class="p">]</span>
		<span class="nx">@bcv</span> <span class="nx">passage</span><span class="p">,</span> <span class="nx">accum</span><span class="p">,</span> <span class="nx">context</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Handle "and following" (e.g., "Matt 1:1ff") by assuming it means to continue to the end of the current context (end of chapter if a verse is given, end of book if a chapter is given).</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">ff: </span><span class="nf">(passage, accum, context) -&gt;</span>
		<span class="nv">passage.start_context = </span><span class="nx">@shallow_clone</span> <span class="nx">context</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>Create a virtual end to pass to <code>@range</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">passage</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">push</span> <span class="nv">type: </span><span class="s2">&quot;integer&quot;</span><span class="p">,</span> <span class="nv">indices: </span><span class="nx">passage</span><span class="p">.</span><span class="nx">indices</span><span class="p">,</span> <span class="nv">value: </span><span class="mi">999</span>
		<span class="p">[[</span><span class="nx">passage</span><span class="p">],</span> <span class="nx">context</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@range</span> <span class="nx">passage</span><span class="p">,</span> <span class="p">[],</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">start_context</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>And then get rid of the virtual end so it doesn't stick around if we need to reparse it later.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">passage</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>Ignore any warnings that the end chapter / verse doesn't exist.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">delete</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">passages</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">valid</span><span class="p">.</span><span class="nx">end_verse_not_exist</span> <span class="k">if</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">passages</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">valid</span><span class="p">.</span><span class="nx">end_verse_not_exist</span><span class="o">?</span>
		<span class="k">delete</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">passages</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">valid</span><span class="p">.</span><span class="nx">end_chapter_not_exist</span> <span class="k">if</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">passages</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">valid</span><span class="p">.</span><span class="nx">end_chapter_not_exist</span><span class="o">?</span>
		<span class="k">delete</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">passages</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">end</span><span class="p">.</span><span class="nx">original_c</span> <span class="k">if</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">passages</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">end</span><span class="p">.</span><span class="nx">original_c</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p><code>translations</code> was handled in <code>@range</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">accum</span><span class="p">.</span><span class="nx">push</span> <span class="nx">passage</span>
		<span class="nx">passage</span><span class="p">.</span><span class="nx">absolute_indices</span> <span class="o">?=</span> <span class="nx">@get_absolute_indices</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">indices</span>
		<span class="p">[</span><span class="nx">accum</span><span class="p">,</span> <span class="nx">context</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>Handle "Ps 3-4:title" or "Acts 2:22-27. Title"</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">integer_title: </span><span class="nf">(passage, accum, context) -&gt;</span>
		<span class="nv">passage.start_context = </span><span class="nx">@shallow_clone</span> <span class="nx">context</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>If it's not Psalms, treat it as a straight integer, ignoring the "title".</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span> <span class="nx">context</span><span class="p">.</span><span class="nx">b</span> <span class="o">isnt</span> <span class="s2">&quot;Ps&quot;</span>
			<span class="k">return</span> <span class="nx">@integer</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">accum</span><span class="p">,</span> <span class="nx">context</span>
		<span class="nx">passage</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nv">type: </span><span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="nv">value: </span><span class="p">[</span><span class="nx">passage</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="nv">indices: </span><span class="p">[</span><span class="nx">passage</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>Add a <code>v</code> object.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">v_indices = </span><span class="p">[</span><span class="nx">passage</span><span class="p">.</span><span class="nx">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">5</span><span class="p">,</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
		<span class="nx">passage</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nv">type: </span><span class="s2">&quot;v&quot;</span><span class="p">,</span> <span class="nv">value: </span><span class="p">[{</span><span class="nv">type: </span><span class="s2">&quot;integer&quot;</span><span class="p">,</span> <span class="nv">value: </span><span class="mi">1</span><span class="p">,</span> <span class="nv">indices: </span><span class="nx">v_indices</span><span class="p">}],</span> <span class="nv">indices: </span><span class="nx">v_indices</span><span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>Not for reparsing but in case we're curious later.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">passage.original_type = </span><span class="s2">&quot;integer_title&quot;</span>
		<span class="nv">passage.type = </span><span class="s2">&quot;cv&quot;</span>
		<span class="nx">@cv</span> <span class="nx">passage</span><span class="p">,</span> <span class="nx">accum</span><span class="p">,</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">start_context</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>Pass the integer off to whichever handler is relevant.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">integer: </span><span class="nf">(passage, accum, context) -&gt;</span>
		<span class="k">return</span> <span class="nx">@v</span> <span class="nx">passage</span><span class="p">,</span> <span class="nx">accum</span><span class="p">,</span> <span class="nx">context</span> <span class="k">if</span> <span class="nx">context</span><span class="p">.</span><span class="nx">v</span><span class="o">?</span>
		<span class="k">return</span> <span class="nx">@c</span> <span class="nx">passage</span><span class="p">,</span> <span class="nx">accum</span><span class="p">,</span> <span class="nx">context</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>Handle a sequence of references. This is the only function that can return more than one object in the <code>passage.passages</code> array.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">sequence: </span><span class="nf">(passage, accum, context) -&gt;</span>
		<span class="nv">passage.start_context = </span><span class="nx">@shallow_clone</span> <span class="nx">context</span>
		<span class="nv">passage.passages = </span><span class="p">[]</span>
		<span class="k">for</span> <span class="nx">obj</span> <span class="k">in</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">value</span>
			<span class="p">[[</span><span class="nx">psg</span><span class="p">],</span> <span class="nx">context</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@handle_array</span> <span class="nx">obj</span><span class="p">,</span> <span class="p">[],</span> <span class="nx">context</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>There's only more than one <code>sub_psg</code> if there was a range error.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">for</span> <span class="nx">sub_psg</span> <span class="k">in</span> <span class="nx">psg</span><span class="p">.</span><span class="nx">passages</span>
				<span class="nx">sub_psg</span><span class="p">.</span><span class="nx">type</span> <span class="o">?=</span> <span class="nx">psg</span><span class="p">.</span><span class="nx">type</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>Add the indices so we can possibly retrieve them later, depending on our <code>sequence_combination_strategy</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nx">sub_psg</span><span class="p">.</span><span class="nx">absolute_indices</span> <span class="o">?=</span> <span class="nx">psg</span><span class="p">.</span><span class="nx">absolute_indices</span>
				<span class="nv">sub_psg.translations = </span><span class="nx">psg</span><span class="p">.</span><span class="nx">start_context</span><span class="p">.</span><span class="nx">translations</span> <span class="k">if</span> <span class="nx">psg</span><span class="p">.</span><span class="nx">start_context</span><span class="p">.</span><span class="nx">translations</span><span class="o">?</span>
				<span class="nx">passage</span><span class="p">.</span><span class="nx">passages</span><span class="p">.</span><span class="nx">push</span> <span class="nx">sub_psg</span>
		<span class="nx">unless</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">absolute_indices</span><span class="o">?</span>
			<span class="k">if</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">passages</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
				<span class="nv">passage.absolute_indices = </span><span class="p">[</span><span class="nx">passage</span><span class="p">.</span><span class="nx">passages</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">absolute_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">passages</span><span class="p">[</span><span class="nx">passage</span><span class="p">.</span><span class="nx">passages</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="nx">absolute_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
			<span class="k">else</span>
				<span class="nv">passage.absolute_indices = </span> <span class="nx">@get_absolute_indices</span>  <span class="nx">passage</span><span class="p">.</span><span class="nx">indices</span>
		<span class="nx">accum</span><span class="p">.</span><span class="nx">push</span> <span class="nx">passage</span>
		<span class="p">[</span><span class="nx">accum</span><span class="p">,</span> <span class="nx">context</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>Handle a verse, either as part of a sequence or because someone explicitly wrote "verse".</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">v: </span><span class="nf">(passage, accum, context) -&gt;</span>
		<span class="nv">v = </span><span class="k">if</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">type</span> <span class="o">is</span> <span class="s2">&quot;integer&quot;</span> <span class="k">then</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">value</span> <span class="k">else</span> <span class="nx">@pluck</span><span class="p">(</span><span class="s2">&quot;integer&quot;</span><span class="p">,</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">value</span><span class="p">).</span><span class="nx">value</span>
		<span class="nv">passage.start_context = </span><span class="nx">@shallow_clone</span> <span class="nx">context</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>The chapter context might not be set if it follows a book in a sequence</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">c = </span><span class="k">if</span> <span class="nx">context</span><span class="p">.</span><span class="nx">c</span><span class="o">?</span> <span class="k">then</span> <span class="nx">context</span><span class="p">.</span><span class="nx">c</span> <span class="k">else</span> <span class="mi">1</span>
		<span class="nv">valid = </span><span class="nx">@validate_ref</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">start_context</span><span class="p">.</span><span class="nx">translations</span><span class="p">,</span> <span class="p">{</span><span class="nv">b: </span><span class="nx">context</span><span class="p">.</span><span class="nx">b</span><span class="p">,</span> <span class="nv">c: </span><span class="nx">c</span><span class="p">,</span> <span class="nv">v: </span><span class="nx">v</span><span class="p">}</span>
		<span class="p">[</span><span class="nx">no_c</span><span class="p">,</span> <span class="nx">v</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@fix_start_zeroes</span> <span class="nx">valid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">v</span>
		<span class="nv">passage.passages = </span><span class="p">[</span><span class="nv">start: </span><span class="p">{</span><span class="nv">b: </span><span class="nx">context</span><span class="p">.</span><span class="nx">b</span><span class="p">,</span> <span class="nv">c: </span><span class="nx">c</span><span class="p">,</span> <span class="nv">v: </span><span class="nx">v</span><span class="p">},</span> <span class="nv">end: </span><span class="p">{</span><span class="nv">b: </span><span class="nx">context</span><span class="p">.</span><span class="nx">b</span><span class="p">,</span> <span class="nv">c: </span><span class="nx">c</span><span class="p">,</span> <span class="nv">v: </span><span class="nx">v</span><span class="p">},</span> <span class="nv">valid: </span><span class="nx">valid</span><span class="p">]</span>
		<span class="nx">passage</span><span class="p">.</span><span class="nx">passages</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nv">translations = </span><span class="nx">passage</span><span class="p">.</span><span class="nx">start_context</span><span class="p">.</span><span class="nx">translations</span> <span class="k">if</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">start_context</span><span class="p">.</span><span class="nx">translations</span><span class="o">?</span>
		<span class="nx">passage</span><span class="p">.</span><span class="nx">absolute_indices</span> <span class="o">?=</span> <span class="nx">@get_absolute_indices</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">indices</span>
		<span class="nx">accum</span><span class="p">.</span><span class="nx">push</span> <span class="nx">passage</span>
		<span class="nv">context.v = </span><span class="nx">v</span>
		<span class="p">[</span><span class="nx">accum</span><span class="p">,</span> <span class="nx">context</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <h2>Ranges</h2>

<p>Handle any type of start and end range.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">range: </span><span class="nf">(passage, accum, context) -&gt;</span>
		<span class="nv">passage.start_context = </span><span class="nx">@shallow_clone</span> <span class="nx">context</span>
		<span class="p">[</span><span class="nx">start</span><span class="p">,</span> <span class="nx">end</span><span class="p">]</span> <span class="o">=</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">value</span></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>Matt 5-verse 6 = Matt.5.6</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span> <span class="nx">end</span><span class="p">.</span><span class="nx">type</span> <span class="o">is</span> <span class="s2">&quot;v&quot;</span> <span class="o">and</span> <span class="p">(</span><span class="nx">start</span><span class="p">.</span><span class="nx">type</span> <span class="o">is</span> <span class="s2">&quot;bc&quot;</span> <span class="o">or</span> <span class="nx">start</span><span class="p">.</span><span class="nx">type</span> <span class="o">is</span> <span class="s2">&quot;c&quot;</span><span class="p">)</span> <span class="o">and</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">end_range_digits_strategy</span> <span class="o">is</span> <span class="s2">&quot;verse&quot;</span>
			<span class="k">return</span> <span class="nx">@range_change_integer_end</span> <span class="nx">passage</span><span class="p">,</span> <span class="nx">accum</span></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>These always return exactly one object that we're interested in.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="p">[[</span><span class="nx">start</span><span class="p">],</span> <span class="nx">context</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@handle_obj</span> <span class="nx">start</span><span class="p">,</span> <span class="p">[],</span> <span class="nx">context</span>
		<span class="p">[[</span><span class="nx">end</span><span class="p">],</span> <span class="nx">context</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@handle_obj</span> <span class="nx">end</span><span class="p">,</span> <span class="p">[],</span> <span class="nx">context</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>If we had to change the start or end <code>type</code>s, make sure that's reflected in the <code>value</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">passage.value = </span><span class="p">[</span><span class="nx">start</span><span class="p">,</span> <span class="nx">end</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>Similarly, if we had to adjust the indices, make sure they're reflected in the indices for the range.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">passage.indices = </span><span class="p">[</span><span class="nx">start</span><span class="p">.</span><span class="nx">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">end</span><span class="p">.</span><span class="nx">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p>We'll also need to recalculate these if they exist.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">delete</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">absolute_indices</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>Create the prospective start and end objects that will end up in <code>passage.passages</code></p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">start_obj = b: </span><span class="nx">start</span><span class="p">.</span><span class="nx">passages</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">start</span><span class="p">.</span><span class="nx">b</span><span class="p">,</span> <span class="nv">c: </span><span class="nx">start</span><span class="p">.</span><span class="nx">passages</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">start</span><span class="p">.</span><span class="nx">c</span><span class="p">,</span> <span class="nv">v: </span><span class="nx">start</span><span class="p">.</span><span class="nx">passages</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">start</span><span class="p">.</span><span class="nx">v</span><span class="p">,</span> <span class="nv">type: </span><span class="nx">start</span><span class="p">.</span><span class="nx">type</span>
		<span class="nv">end_obj = b: </span><span class="nx">end</span><span class="p">.</span><span class="nx">passages</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">end</span><span class="p">.</span><span class="nx">b</span><span class="p">,</span> <span class="nv">c: </span><span class="nx">end</span><span class="p">.</span><span class="nx">passages</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">end</span><span class="p">.</span><span class="nx">c</span><span class="p">,</span> <span class="nv">v: </span><span class="nx">end</span><span class="p">.</span><span class="nx">passages</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">end</span><span class="p">.</span><span class="nx">v</span><span class="p">,</span> <span class="nv">type: </span><span class="nx">end</span><span class="p">.</span><span class="nx">type</span>
		<span class="nv">end_obj.c = </span><span class="mi">0</span> <span class="k">if</span> <span class="nx">end</span><span class="p">.</span><span class="nx">passages</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">valid</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">start_chapter_is_zero</span>
		<span class="nv">end_obj.v = </span><span class="mi">0</span> <span class="k">if</span> <span class="nx">end</span><span class="p">.</span><span class="nx">passages</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">valid</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">start_verse_is_zero</span>
		<span class="nv">valid = </span><span class="nx">@validate_ref</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">start_context</span><span class="p">.</span><span class="nx">translations</span><span class="p">,</span> <span class="nx">start_obj</span><span class="p">,</span> <span class="nx">end_obj</span>
		<span class="k">if</span> <span class="nx">valid</span><span class="p">.</span><span class="nx">valid</span></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>If Heb 13-15, treat it as Heb 13:15. This may be too clever for its own good.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span> <span class="nx">valid</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">end_chapter_not_exist</span> <span class="o">and</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">end_range_digits_strategy</span> <span class="o">is</span> <span class="s2">&quot;verse&quot;</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">start_obj</span><span class="p">.</span><span class="nx">v</span><span class="o">?</span> <span class="o">and</span> <span class="p">(</span><span class="nx">end</span><span class="p">.</span><span class="nx">type</span> <span class="o">is</span> <span class="s2">&quot;integer&quot;</span> <span class="o">or</span> <span class="nx">end</span><span class="p">.</span><span class="nx">type</span> <span class="o">is</span> <span class="s2">&quot;v&quot;</span><span class="p">)</span>
				<span class="nv">temp_value = </span><span class="k">if</span> <span class="nx">end</span><span class="p">.</span><span class="nx">type</span> <span class="o">is</span> <span class="s2">&quot;v&quot;</span> <span class="k">then</span> <span class="nx">@pluck</span> <span class="s2">&quot;integer&quot;</span><span class="p">,</span> <span class="nx">end</span><span class="p">.</span><span class="nx">value</span> <span class="k">else</span> <span class="nx">end</span><span class="p">.</span><span class="nx">value</span>
				<span class="nv">temp_valid = </span><span class="nx">@validate_ref</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">start_context</span><span class="p">.</span><span class="nx">translations</span><span class="p">,</span> <span class="p">{</span><span class="nv">b: </span><span class="nx">start_obj</span><span class="p">.</span><span class="nx">b</span><span class="p">,</span> <span class="nv">c: </span><span class="nx">start_obj</span><span class="p">.</span><span class="nx">c</span><span class="p">,</span> <span class="nv">v: </span><span class="nx">temp_value</span><span class="p">}</span>
				<span class="k">return</span> <span class="nx">@range_change_integer_end</span> <span class="nx">passage</span><span class="p">,</span> <span class="nx">accum</span> <span class="k">if</span> <span class="nx">temp_valid</span><span class="p">.</span><span class="nx">valid</span></pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <p>If "John 10:22-42 vs 27", we're possibly misreading the "42 vs 27" as a <code>cv</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span> <span class="nx">valid</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">end_chapter_not_exist</span> <span class="o">and</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">end_range_digits_strategy</span> <span class="o">is</span> <span class="s2">&quot;verse&quot;</span> <span class="o">and</span> <span class="nx">start_obj</span><span class="p">.</span><span class="nx">v</span><span class="o">?</span> <span class="o">and</span> <span class="nx">end</span><span class="p">.</span><span class="nx">type</span> <span class="o">is</span> <span class="s2">&quot;cv&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <p>Make sure that what we're changing it to actually exists (that the chapter number can become the verse number, and the verse number is also valid in the current chapter).</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nv">temp_valid = </span><span class="nx">@validate_ref</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">start_context</span><span class="p">.</span><span class="nx">translations</span><span class="p">,</span> <span class="p">{</span><span class="nx">b</span><span class="o">:</span><span class="nx">end_obj</span><span class="p">.</span><span class="nx">b</span><span class="p">,</span> <span class="nv">c: </span><span class="nx">start_obj</span><span class="p">.</span><span class="nx">c</span><span class="p">,</span> <span class="nv">v: </span><span class="nx">end_obj</span><span class="p">.</span><span class="nx">c</span><span class="p">}</span>
				<span class="nv">temp_valid = </span><span class="nx">@validate_ref</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">start_context</span><span class="p">.</span><span class="nx">translations</span><span class="p">,</span> <span class="p">{</span><span class="nx">b</span><span class="o">:</span><span class="nx">end_obj</span><span class="p">.</span><span class="nx">b</span><span class="p">,</span> <span class="nv">c: </span><span class="nx">start_obj</span><span class="p">.</span><span class="nx">c</span><span class="p">,</span> <span class="nv">v: </span><span class="nx">end_obj</span><span class="p">.</span><span class="nx">v</span><span class="p">}</span> <span class="k">if</span> <span class="nx">temp_valid</span><span class="p">.</span><span class="nx">valid</span>
				<span class="k">return</span> <span class="nx">@range_change_cv_end</span> <span class="nx">passage</span><span class="p">,</span> <span class="nx">accum</span> <span class="k">if</span> <span class="nx">temp_valid</span><span class="p">.</span><span class="nx">valid</span></pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <p>Otherwise, snap start/end chapters/verses if they're too high or low.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">@range_validate</span> <span class="nx">valid</span><span class="p">,</span> <span class="nx">start_obj</span><span class="p">,</span> <span class="nx">end_obj</span><span class="p">,</span> <span class="nx">passage</span>
		<span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <p>Is it not valid because the end is before the start and the <code>end</code> is an <code>integer</code> (Matt 15-6) or a <code>cv</code> (Matt 15-6:2) (since anything else resets our expectations)?</p>

<p>Only go with a <code>cv</code> if it's the chapter that's too low (to avoid doing weird things with 31:30-31:1).</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span> <span class="p">((</span><span class="nx">valid</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">end_chapter_before_start</span> <span class="o">or</span> <span class="nx">valid</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">end_verse_before_start</span><span class="p">)</span> <span class="o">and</span> <span class="p">(</span><span class="nx">end</span><span class="p">.</span><span class="nx">type</span> <span class="o">is</span> <span class="s2">&quot;integer&quot;</span> <span class="o">or</span> <span class="nx">end</span><span class="p">.</span><span class="nx">type</span> <span class="o">is</span> <span class="s2">&quot;v&quot;</span><span class="p">)</span> <span class="o">or</span> <span class="p">(</span><span class="nx">valid</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">end_chapter_before_start</span> <span class="o">and</span> <span class="nx">end</span><span class="p">.</span><span class="nx">type</span> <span class="o">is</span> <span class="s2">&quot;cv&quot;</span><span class="p">))</span>
				<span class="nv">new_end = </span><span class="nx">@range_check_new_end</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">start_context</span><span class="p">.</span><span class="nx">translations</span><span class="p">,</span> <span class="nx">start_obj</span><span class="p">,</span> <span class="nx">end_obj</span><span class="p">,</span> <span class="nx">valid</span></pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <p>If that's the case, then reparse the current passage object after correcting the end value, which is an integer.</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="k">return</span> <span class="nx">@range_change_end</span> <span class="nx">passage</span><span class="p">,</span> <span class="nx">accum</span><span class="p">,</span> <span class="nx">new_end</span> <span class="k">if</span> <span class="nx">new_end</span> <span class="o">&gt;</span> <span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <p>If someone enters "Jer 33-11", they probably mean "Jer.33.11"; as above, this may be too clever for its own good.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">end_range_digits_strategy</span> <span class="o">is</span> <span class="s2">&quot;verse&quot;</span> <span class="o">and</span> <span class="nx">start_obj</span><span class="p">.</span><span class="nx">v</span> <span class="o">is</span> <span class="kc">undefined</span> <span class="o">and</span> <span class="p">(</span><span class="nx">end</span><span class="p">.</span><span class="nx">type</span> <span class="o">is</span> <span class="s2">&quot;integer&quot;</span> <span class="o">or</span> <span class="nx">end</span><span class="p">.</span><span class="nx">type</span> <span class="o">is</span> <span class="s2">&quot;v&quot;</span><span class="p">)</span>
				<span class="nv">temp_value = </span><span class="k">if</span> <span class="nx">end</span><span class="p">.</span><span class="nx">type</span> <span class="o">is</span> <span class="s2">&quot;v&quot;</span> <span class="k">then</span> <span class="nx">@pluck</span> <span class="s2">&quot;integer&quot;</span><span class="p">,</span> <span class="nx">end</span><span class="p">.</span><span class="nx">value</span> <span class="k">else</span> <span class="nx">end</span><span class="p">.</span><span class="nx">value</span>
				<span class="nv">temp_valid = </span><span class="nx">@validate_ref</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">start_context</span><span class="p">.</span><span class="nx">translations</span><span class="p">,</span> <span class="p">{</span><span class="nv">b: </span><span class="nx">start_obj</span><span class="p">.</span><span class="nx">b</span><span class="p">,</span> <span class="nv">c: </span><span class="nx">start_obj</span><span class="p">.</span><span class="nx">c</span><span class="p">,</span> <span class="nv">v: </span><span class="nx">temp_value</span><span class="p">}</span>
				<span class="k">return</span> <span class="nx">@range_change_integer_end</span> <span class="nx">passage</span><span class="p">,</span> <span class="nx">accum</span> <span class="k">if</span> <span class="nx">temp_valid</span><span class="p">.</span><span class="nx">valid</span></pre></div>             </td>           </tr>                               <tr id="section-70">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-70">&#182;</a>               </div>               <p>Otherwise, if we couldn't fix the range, then treat the range as a sequence.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="p">[</span><span class="nx">passage</span><span class="p">.</span><span class="nx">original_type</span><span class="p">,</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">type</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">passage</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span> <span class="s2">&quot;sequence&quot;</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-71">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-71">&#182;</a>               </div>               <p>Construct the sequence value in the format expected.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="p">[</span><span class="nx">passage</span><span class="p">.</span><span class="nx">original_value</span><span class="p">,</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">value</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[</span><span class="nx">start</span><span class="p">,</span> <span class="nx">end</span><span class="p">],</span> <span class="p">[[</span><span class="nx">start</span><span class="p">],</span> <span class="p">[</span><span class="nx">end</span><span class="p">]]]</span></pre></div>             </td>           </tr>                               <tr id="section-72">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-72">&#182;</a>               </div>               <p>Don't use the <code>context</code> object because we've changed it in this function.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">return</span> <span class="nx">@handle_obj</span> <span class="nx">passage</span><span class="p">,</span> <span class="nx">accum</span><span class="p">,</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">start_context</span></pre></div>             </td>           </tr>                               <tr id="section-73">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-73">&#182;</a>               </div>               <p>We've already reset the indices to match the indices of the contained objects.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">passage</span><span class="p">.</span><span class="nx">absolute_indices</span> <span class="o">?=</span> <span class="nx">@get_absolute_indices</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">indices</span>
		<span class="nv">passage.passages = </span><span class="p">[</span><span class="nv">start: </span><span class="nx">start_obj</span><span class="p">,</span> <span class="nv">end: </span><span class="nx">end_obj</span><span class="p">,</span> <span class="nv">valid: </span><span class="nx">valid</span><span class="p">]</span>
		<span class="nx">passage</span><span class="p">.</span><span class="nx">passages</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nv">translations = </span><span class="nx">passage</span><span class="p">.</span><span class="nx">start_context</span><span class="p">.</span><span class="nx">translations</span> <span class="k">if</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">start_context</span><span class="p">.</span><span class="nx">translations</span><span class="o">?</span>
		<span class="nx">accum</span><span class="p">.</span><span class="nx">push</span> <span class="nx">passage</span>
		<span class="p">[</span><span class="nx">accum</span><span class="p">,</span> <span class="nx">context</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-74">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-74">&#182;</a>               </div>               <p>For Ps 122-23, treat the 23 as 123.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">range_change_end: </span><span class="nf">(passage, accum, new_end) -&gt;</span>
		<span class="p">[</span><span class="nx">start</span><span class="p">,</span> <span class="nx">end</span><span class="p">]</span> <span class="o">=</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">value</span>
		<span class="k">if</span> <span class="nx">end</span><span class="p">.</span><span class="nx">type</span> <span class="o">is</span> <span class="s2">&quot;integer&quot;</span>
			<span class="nv">end.original_value = </span><span class="nx">end</span><span class="p">.</span><span class="nx">value</span>
			<span class="nv">end.value = </span><span class="nx">new_end</span>
		<span class="k">else</span> <span class="k">if</span> <span class="nx">end</span><span class="p">.</span><span class="nx">type</span> <span class="o">is</span> <span class="s2">&quot;v&quot;</span>
			<span class="nv">new_obj = </span><span class="nx">@pluck</span> <span class="s2">&quot;integer&quot;</span><span class="p">,</span> <span class="nx">end</span><span class="p">.</span><span class="nx">value</span>
			<span class="nv">new_obj.original_value = </span><span class="nx">new_obj</span><span class="p">.</span><span class="nx">value</span>
			<span class="nv">new_obj.value = </span><span class="nx">new_end</span>
		<span class="k">else</span> <span class="k">if</span> <span class="nx">end</span><span class="p">.</span><span class="nx">type</span> <span class="o">is</span> <span class="s2">&quot;cv&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-75">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-75">&#182;</a>               </div>               <p>Get the chapter object and assign it (in place) the new value.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nv">new_obj = </span><span class="nx">@pluck</span> <span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="nx">end</span><span class="p">.</span><span class="nx">value</span>
			<span class="nv">new_obj.original_value = </span><span class="nx">new_obj</span><span class="p">.</span><span class="nx">value</span>
			<span class="nv">new_obj.value = </span><span class="nx">new_end</span>
		<span class="nx">@handle_obj</span> <span class="nx">passage</span><span class="p">,</span> <span class="nx">accum</span><span class="p">,</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">start_context</span></pre></div>             </td>           </tr>                               <tr id="section-76">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-76">&#182;</a>               </div>               <p>For "Jer 33-11", treat the "11" as a verse.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">range_change_integer_end: </span><span class="nf">(passage, accum) -&gt;</span>
		<span class="p">[</span><span class="nx">start</span><span class="p">,</span> <span class="nx">end</span><span class="p">]</span> <span class="o">=</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">value</span>
		<span class="nv">passage.original_type = </span><span class="nx">passage</span><span class="p">.</span><span class="nx">type</span>
		<span class="nv">passage.original_value = </span><span class="p">[</span><span class="nx">start</span><span class="p">,</span> <span class="nx">end</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-77">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-77">&#182;</a>               </div>               <p>The start.type is only bc, c, or integer; we're just adding a v for the first two.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">passage.type = </span><span class="k">if</span> <span class="nx">start</span><span class="p">.</span><span class="nx">type</span> <span class="o">is</span> <span class="s2">&quot;integer&quot;</span> <span class="k">then</span> <span class="s2">&quot;cv&quot;</span> <span class="k">else</span> <span class="nx">start</span><span class="p">.</span><span class="nx">type</span> <span class="o">+</span> <span class="s2">&quot;v&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-78">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-78">&#182;</a>               </div>               <p>Create the object in the expected format if it's not already a verse.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">passage</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nv">type: </span><span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="nv">value: </span><span class="p">[</span><span class="nx">start</span><span class="p">],</span> <span class="nv">indices: </span><span class="nx">start</span><span class="p">.</span><span class="nx">indices</span><span class="p">}</span> <span class="k">if</span> <span class="nx">start</span><span class="p">.</span><span class="nx">type</span> <span class="o">is</span> <span class="s2">&quot;integer&quot;</span>
		<span class="nx">passage</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nv">type: </span><span class="s2">&quot;v&quot;</span><span class="p">,</span> <span class="nv">value: </span><span class="p">[</span><span class="nx">end</span><span class="p">],</span> <span class="nv">indices: </span><span class="nx">end</span><span class="p">.</span><span class="nx">indices</span><span class="p">}</span> <span class="k">if</span> <span class="nx">end</span><span class="p">.</span><span class="nx">type</span> <span class="o">is</span> <span class="s2">&quot;integer&quot;</span>
		<span class="nx">@handle_obj</span> <span class="nx">passage</span><span class="p">,</span> <span class="nx">accum</span><span class="p">,</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">start_context</span></pre></div>             </td>           </tr>                               <tr id="section-79">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-79">&#182;</a>               </div>               <p>In cases like "John 10:22-42 vs 27", treat it as "10:22-42,47" instead of "10:22-42:27".</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">range_change_cv_end: </span><span class="nf">(passage, accum) -&gt;</span>
		<span class="p">[</span><span class="nx">start</span><span class="p">,</span> <span class="nx">end</span><span class="p">]</span> <span class="o">=</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">value</span>
		<span class="nv">passage.original_type = </span><span class="nx">passage</span><span class="p">.</span><span class="nx">type</span>
		<span class="nv">passage.original_value = </span><span class="p">[</span><span class="nx">start</span><span class="p">,</span> <span class="nx">end</span><span class="p">]</span>
		<span class="nv">passage.type = </span><span class="s2">&quot;sequence&quot;</span>
		<span class="p">[</span><span class="nx">new_range_end</span><span class="p">,</span> <span class="nx">new_sequence_end</span><span class="p">]</span> <span class="o">=</span> <span class="nx">end</span><span class="p">.</span><span class="nx">value</span></pre></div>             </td>           </tr>                               <tr id="section-80">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-80">&#182;</a>               </div>               <p>If a translation sequence needs to come back here and reuse it, make sure it can get the old object (<code>end</code>)--it only looks in accum, not in deep objects.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">new_range_end = </span><span class="nx">@shallow_clone</span> <span class="nx">new_range_end</span></pre></div>             </td>           </tr>                               <tr id="section-81">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-81">&#182;</a>               </div>               <p>Was "c" but change it to "v" to serve as the end of a range.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">new_range_end.original_type = </span><span class="nx">new_range_end</span><span class="p">.</span><span class="nx">type</span>
		<span class="nv">new_range_end.type = </span><span class="s2">&quot;v&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-82">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-82">&#182;</a>               </div>               <p>Change it into a sequence consisting of a range and a free verse.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">passage.value = </span><span class="p">[</span>
			<span class="p">[{</span><span class="nv">type: </span><span class="s2">&quot;range&quot;</span><span class="p">,</span> <span class="nv">value: </span><span class="p">[</span><span class="nx">start</span><span class="p">,</span> <span class="nx">new_range_end</span><span class="p">],</span> <span class="nv">indices: </span><span class="p">[</span><span class="nx">start</span><span class="p">.</span><span class="nx">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">new_range_end</span><span class="p">.</span><span class="nx">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]]}]</span>
			<span class="p">[</span><span class="nx">new_sequence_end</span><span class="p">]</span>
		<span class="p">]</span>
		<span class="nx">@sequence</span> <span class="nx">passage</span><span class="p">,</span> <span class="nx">accum</span><span class="p">,</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">start_context</span>

	<span class="nv">range_validate: </span><span class="nf">(valid, start_obj, end_obj, passage) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-83">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-83">&#182;</a>               </div>               <p>If it's valid but the end range goes too high, snap it back to the appropriate chapter or verse.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span> <span class="nx">valid</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">end_chapter_not_exist</span></pre></div>             </td>           </tr>                               <tr id="section-84">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-84">&#182;</a>               </div>               <p><code>end_chapter_not_exist</code> gives the highest chapter for the book.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nv">end_obj.original_c = </span><span class="nx">end_obj</span><span class="p">.</span><span class="nx">c</span>
			<span class="nv">end_obj.c = </span><span class="nx">valid</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">end_chapter_not_exist</span></pre></div>             </td>           </tr>                               <tr id="section-85">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-85">&#182;</a>               </div>               <p>If we've snapped it back to the last chapter and there's a verse, also snap to the end of that chapter. If we've already overshot the chapter, there's no reason to think we've gotten the verse right; Gen 50:1-51:1 = Gen 50:1-26 = Gen 50. If there's no verse, we don't need to worry about it.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span> <span class="nx">end_obj</span><span class="p">.</span><span class="nx">v</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-86">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-86">&#182;</a>               </div>               <p><code>end_verse_not_exist</code> gives the maximum verse for the chapter.</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nv">end_obj.v = </span><span class="nx">@validate_ref</span><span class="p">(</span><span class="nx">passage</span><span class="p">.</span><span class="nx">start_context</span><span class="p">.</span><span class="nx">translations</span><span class="p">,</span> <span class="p">{</span><span class="nv">b: </span><span class="nx">end_obj</span><span class="p">.</span><span class="nx">b</span><span class="p">,</span> <span class="nv">c: </span><span class="nx">end_obj</span><span class="p">.</span><span class="nx">c</span><span class="p">,</span> <span class="nv">v: </span><span class="mi">999</span><span class="p">}).</span><span class="nx">messages</span><span class="p">.</span><span class="nx">end_verse_not_exist</span></pre></div>             </td>           </tr>                               <tr id="section-87">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-87">&#182;</a>               </div>               <p>If the end verse is too high, snap back to the maximum verse.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">else</span> <span class="k">if</span> <span class="nx">valid</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">end_verse_not_exist</span>
			<span class="nv">end_obj.original_v = </span><span class="nx">end_obj</span><span class="p">.</span><span class="nx">v</span>
			<span class="nv">end_obj.v = </span><span class="nx">valid</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">end_verse_not_exist</span>
		<span class="nv">end_obj.v = </span><span class="nx">valid</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">end_verse_is_zero</span> <span class="k">if</span> <span class="nx">valid</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">end_verse_is_zero</span> <span class="o">and</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">zero_verse_strategy</span> <span class="o">isnt</span> <span class="s2">&quot;allow&quot;</span>
		<span class="nv">end_obj.c = </span><span class="nx">valid</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">end_chapter_is_zero</span> <span class="k">if</span> <span class="nx">valid</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">end_chapter_is_zero</span>
		<span class="p">[</span><span class="nx">start_obj</span><span class="p">.</span><span class="nx">c</span><span class="p">,</span> <span class="nx">start_obj</span><span class="p">.</span><span class="nx">v</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@fix_start_zeroes</span> <span class="nx">valid</span><span class="p">,</span> <span class="nx">start_obj</span><span class="p">.</span><span class="nx">c</span><span class="p">,</span> <span class="nx">start_obj</span><span class="p">.</span><span class="nx">v</span>
		<span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-88">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-88">&#182;</a>               </div>               <p>If the start chapter or verse is 0, convert it to a 1. <code>valid.valid</code> is <code>false</code> if the <code>zero_*_strategy</code> is <code>error</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">fix_start_zeroes: </span><span class="nf">(valid, c, v) -&gt;</span>
		<span class="k">if</span> <span class="nx">valid</span><span class="p">.</span><span class="nx">valid</span>
			<span class="nv">c = </span><span class="nx">valid</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">start_chapter_is_zero</span> <span class="k">if</span> <span class="nx">valid</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">start_chapter_is_zero</span>
			<span class="nv">v = </span><span class="nx">valid</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">start_verse_is_zero</span> <span class="k">if</span> <span class="nx">valid</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">start_verse_is_zero</span> <span class="o">and</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">zero_verse_strategy</span> <span class="o">isnt</span> <span class="s2">&quot;allow&quot;</span>
		<span class="p">[</span><span class="nx">c</span><span class="p">,</span> <span class="nx">v</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-89">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-89">&#182;</a>               </div>               <p>If a new end chapter/verse in a range may be necessary, calculate it.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">range_check_new_end: </span><span class="nf">(translations, start_obj, end_obj, valid) -&gt;</span>
		<span class="nv">new_end = </span><span class="mi">0</span>
		<span class="nv">type = </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-90">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-90">&#182;</a>               </div>               <p>See whether a digit might be omitted (e.g., Gen 22-4 = Gen 22-24)</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span> <span class="nx">valid</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">end_chapter_before_start</span> <span class="k">then</span> <span class="nv">type = </span><span class="s2">&quot;c&quot;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="nx">valid</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">end_verse_before_start</span> <span class="k">then</span> <span class="nv">type = </span><span class="s2">&quot;v&quot;</span>
		<span class="nv">new_end = </span><span class="nx">@range_get_new_end_value</span><span class="p">(</span><span class="nx">start_obj</span><span class="p">,</span> <span class="nx">end_obj</span><span class="p">,</span> <span class="nx">valid</span><span class="p">,</span> <span class="nx">type</span><span class="p">)</span> <span class="k">if</span> <span class="nx">type</span><span class="o">?</span>
		<span class="k">if</span> <span class="nx">new_end</span> <span class="o">&gt;</span> <span class="mi">0</span>
			<span class="nv">obj_to_validate = b: </span><span class="nx">end_obj</span><span class="p">.</span><span class="nx">b</span><span class="p">,</span> <span class="nv">c: </span><span class="nx">end_obj</span><span class="p">.</span><span class="nx">c</span><span class="p">,</span> <span class="nv">v: </span><span class="nx">end_obj</span><span class="p">.</span><span class="nx">v</span>
			<span class="nx">obj_to_validate</span><span class="p">[</span><span class="nx">type</span><span class="p">]</span> <span class="o">=</span> <span class="nx">new_end</span>
			<span class="nv">new_valid = </span><span class="nx">@validate_ref</span> <span class="nx">translations</span><span class="p">,</span> <span class="nx">obj_to_validate</span>
			<span class="nv">new_end = </span><span class="mi">0</span> <span class="nx">unless</span> <span class="nx">new_valid</span><span class="p">.</span><span class="nx">valid</span>
		<span class="nx">new_end</span></pre></div>             </td>           </tr>                               <tr id="section-91">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-91">&#182;</a>               </div>               <p>If a sequence has an end chapter/verse that's before the the start, check to see whether it can be salvaged: Gen 28-9 = Gen 28-29; Ps 101-24 = Ps 101-124. The <code>key</code> parameter is either <code>c</code> (for chapter) or <code>v</code> (for verse).</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">range_get_new_end_value: </span><span class="nf">(start_obj, end_obj, valid, key) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-92">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-92">&#182;</a>               </div>               <p>Return 0 unless it's salvageable.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">new_end = </span><span class="mi">0</span>
		<span class="k">return</span> <span class="nx">new_end</span> <span class="k">if</span> <span class="p">((</span><span class="nx">key</span> <span class="o">is</span> <span class="s2">&quot;c&quot;</span> <span class="o">and</span> <span class="nx">valid</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">end_chapter_is_zero</span><span class="p">)</span> <span class="o">or</span> <span class="p">(</span><span class="nx">key</span> <span class="o">is</span> <span class="s2">&quot;v&quot;</span> <span class="o">and</span> <span class="nx">valid</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">end_verse_is_zero</span><span class="p">))</span></pre></div>             </td>           </tr>                               <tr id="section-93">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-93">&#182;</a>               </div>               <p>54-5, not 54-43, 54-3, or 54-4.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span> <span class="nx">start_obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">10</span> <span class="o">and</span> <span class="nx">end_obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="o">and</span> <span class="nx">start_obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">-</span> <span class="mi">10</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">start_obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nx">end_obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-94">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-94">&#182;</a>               </div>               <p>Add the start tens digit to the original end value: 54-5 = 54 through 50 + 5.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nv">new_end = </span><span class="nx">end_obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">start_obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-95">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-95">&#182;</a>               </div>               <p>123-40, not 123-22 or 123-23; 123-4 is taken care of in the first case.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">else</span> <span class="k">if</span> <span class="nx">start_obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">100</span> <span class="o">and</span> <span class="nx">end_obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">100</span> <span class="o">and</span> <span class="nx">start_obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">-</span> <span class="mi">100</span> <span class="o">&lt;</span> <span class="nx">end_obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-96">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-96">&#182;</a>               </div>               <p>Add 100 to the original end value: 100-12 = 100 through 100 + 12.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nv">new_end = </span><span class="nx">end_obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">+</span> <span class="mi">100</span>
		<span class="nx">new_end</span></pre></div>             </td>           </tr>                               <tr id="section-97">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-97">&#182;</a>               </div>               <h2>Translations</h2>

<p>Even a single translation ("NIV") appears as part of a translation sequence. Here we handle the sequence and apply the translations to any previous passages lacking an explicit translation: in "Matt 1, 5 ESV," both <code>Matt 1</code> and <code>5</code> get applied, but in "Matt 1 NIV, 5 ESV," NIV only applies to Matt 1, and ESV only applies to Matt 5.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">translation_sequence: </span><span class="nf">(passage, accum, context) -&gt;</span>
		<span class="nv">translations = </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-98">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-98">&#182;</a>               </div>               <p>First get all the translations in the sequence; the first one is separate from the others (which may not exist).</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">translations</span><span class="p">.</span><span class="nx">push</span> <span class="nv">translation: </span><span class="nx">@books</span><span class="p">[</span><span class="nx">passage</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">value</span><span class="p">].</span><span class="nx">parsed</span>
		<span class="k">for</span> <span class="nx">val</span> <span class="k">in</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-99">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-99">&#182;</a>               </div>               <p><code>val</code> at this point is an array.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nv">val = </span><span class="nx">@books</span><span class="p">[</span><span class="nx">@pluck</span><span class="p">(</span><span class="s2">&quot;translation&quot;</span><span class="p">,</span> <span class="nx">val</span><span class="p">).</span><span class="nx">value</span><span class="p">].</span><span class="nx">parsed</span></pre></div>             </td>           </tr>                               <tr id="section-100">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-100">&#182;</a>               </div>               <p>And now <code>val</code> is the literal, lower-cased match.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">translations</span><span class="p">.</span><span class="nx">push</span> <span class="nv">translation: </span><span class="nx">val</span> <span class="k">if</span> <span class="nx">val</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-101">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-101">&#182;</a>               </div>               <p>We need some metadata to do this right.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">for</span> <span class="nx">translation</span> <span class="k">in</span> <span class="nx">translations</span></pre></div>             </td>           </tr>                               <tr id="section-102">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-102">&#182;</a>               </div>               <p>Do we know anything about this translation? If so, use that. If not, use the default</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nv">alias = </span><span class="k">if</span> <span class="nx">@translations</span><span class="p">.</span><span class="nx">aliases</span><span class="p">[</span><span class="nx">translation</span><span class="p">.</span><span class="nx">translation</span><span class="p">]</span><span class="o">?</span> <span class="k">then</span> <span class="nx">translation</span><span class="p">.</span><span class="nx">translation</span> <span class="k">else</span> <span class="s2">&quot;default&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-103">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-103">&#182;</a>               </div>               <p><code>osis</code> is what we'll eventually use in output.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nv">translation.osis = </span><span class="nx">@translations</span><span class="p">.</span><span class="nx">aliases</span><span class="p">[</span><span class="nx">alias</span><span class="p">].</span><span class="nx">osis</span></pre></div>             </td>           </tr>                               <tr id="section-104">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-104">&#182;</a>               </div>               <p><code>alias</code> is what we use internally to get bcv data for the translation.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nv">translation.alias = </span><span class="nx">@translations</span><span class="p">.</span><span class="nx">aliases</span><span class="p">[</span><span class="nx">alias</span><span class="p">].</span><span class="nx">alias</span></pre></div>             </td>           </tr>                               <tr id="section-105">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-105">&#182;</a>               </div>               <p>Now we need to go back and find the earliest already-parsed passage without a translation. We start with 0 because the below loop will never yield a 0.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span> <span class="nx">accum</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
			<span class="nv">use_i = </span><span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-106">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-106">&#182;</a>               </div>               <p>Start with the most recent and go backward--we don't want to overlap another <code>translation_sequence</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="nx">accum</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">..</span> <span class="mi">0</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-107">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-107">&#182;</a>               </div>               <p>With a new translation comes the possibility that a previously invalid reference will become valid, so reset it to its original type. For example, a multi-book range may be correct in a different translation because the books are in a different order.</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nx">accum</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nv">type = </span><span class="nx">accum</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">original_type</span> <span class="k">if</span> <span class="nx">accum</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">original_type</span><span class="o">?</span>
				<span class="nx">accum</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nv">value = </span><span class="nx">accum</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">original_value</span> <span class="k">if</span> <span class="nx">accum</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">original_value</span><span class="o">?</span>
				<span class="k">continue</span> <span class="nx">unless</span> <span class="nx">accum</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;translation_sequence&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-108">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-108">&#182;</a>               </div>               <p>If we made it here, then we hit a translation sequence, and we know that the item following it is the first one we care about.</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nv">use_i = </span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span>
				<span class="k">break</span></pre></div>             </td>           </tr>                               <tr id="section-109">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-109">&#182;</a>               </div>               <p>Include the translations in the start context.</p>

<p><code>use_i</code> == <code>accum.length</code> if there are two translations sequences in a row separated by, e.g., numbers ("Matt 1 ESV 2-3 NIV").</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span> <span class="nx">use_i</span> <span class="o">&lt;</span> <span class="nx">accum</span><span class="p">.</span><span class="nx">length</span>
				<span class="nx">accum</span><span class="p">[</span><span class="nx">use_i</span><span class="p">].</span><span class="nv">start_context.translations = </span><span class="nx">translations</span></pre></div>             </td>           </tr>                               <tr id="section-110">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-110">&#182;</a>               </div>               <p>The objects in accum are replaced in-place, so we don't need to try to merge them back. We re-parse them because the translation may cause previously valid (or invalid) references to flip the other way--if the new translation includes (or doesn't) the Deuterocanonicals, for example. We ignore the <code>new_accum</code>, but we definitely care about the new <code>context</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="p">[</span><span class="nx">new_accum</span><span class="p">,</span> <span class="nx">context</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@handle_array</span> <span class="nx">accum</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">use_i</span><span class="p">),</span> <span class="p">[],</span> <span class="nx">accum</span><span class="p">[</span><span class="nx">use_i</span><span class="p">].</span><span class="nx">start_context</span></pre></div>             </td>           </tr>                               <tr id="section-111">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-111">&#182;</a>               </div>               <p>We may need these indices later, depending on how we want to output the data.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">passage</span><span class="p">.</span><span class="nx">absolute_indices</span> <span class="o">?=</span> <span class="nx">@get_absolute_indices</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">indices</span></pre></div>             </td>           </tr>                               <tr id="section-112">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-112">&#182;</a>               </div>               <p>Include the <code>translation_sequence</code> object so that we can handle any later <code>translation_sequence</code> objects without overlapping this one.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">accum</span><span class="p">.</span><span class="nx">push</span> <span class="nx">passage</span></pre></div>             </td>           </tr>                               <tr id="section-113">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-113">&#182;</a>               </div>               <p>Don't carry over the translations into any later references; translations only apply backwards.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">delete</span> <span class="nx">context</span><span class="p">.</span><span class="nx">translations</span>
		<span class="p">[</span><span class="nx">accum</span><span class="p">,</span> <span class="nx">context</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-114">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-114">&#182;</a>               </div>               <h2>Utilities</h2>

<p>Pluck the object or value matching a type from an array.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">pluck: </span><span class="nf">(type, passages) -&gt;</span>
		<span class="k">for</span> <span class="nx">passage</span> <span class="k">in</span> <span class="nx">passages</span>
			<span class="k">continue</span> <span class="nx">unless</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">type</span><span class="o">?</span> <span class="o">and</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">type</span> <span class="o">is</span> <span class="nx">type</span>
			<span class="k">return</span> <span class="nx">@pluck</span><span class="p">(</span><span class="s2">&quot;integer&quot;</span><span class="p">,</span> <span class="nx">passage</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span> <span class="k">if</span> <span class="nx">type</span> <span class="o">is</span> <span class="s2">&quot;c&quot;</span> <span class="o">or</span> <span class="nx">type</span> <span class="o">is</span> <span class="s2">&quot;v&quot;</span>
			<span class="k">return</span> <span class="nx">passage</span>
		<span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-115">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-115">&#182;</a>               </div>               <p>Make a shallow clone of an object. Nested objects are referenced, not cloned.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">shallow_clone: </span><span class="nf">(obj) -&gt;</span>
		<span class="nv">out = </span><span class="p">{}</span>
		<span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">val</span> <span class="k">of</span> <span class="nx">obj</span>
			<span class="nx">out</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span>
		<span class="nx">out</span></pre></div>             </td>           </tr>                               <tr id="section-116">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-116">&#182;</a>               </div>               <p>Split a string on a regexp. This is purely for cross-browser (read: IE) compatibility, which </p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-117">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-117">&#182;</a>               </div>               <p>Given a string and initial index, calculate indices for parts of the string. For example, a string that starts at index 10 might have a book that pushes it to index 12 starting at its third character.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">calculate_indices: </span><span class="nf">(match, adjust) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-118">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-118">&#182;</a>               </div>               <p>This gets switched out the first time in the loop; the first item is never a book even if a book is the first part of the string--there's an empty string before it.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">switch_type = </span><span class="s2">&quot;book&quot;</span>
		<span class="nv">indices = </span><span class="p">[]</span>
		<span class="nv">match_index = </span><span class="mi">0</span>
		<span class="nv">adjust = </span><span class="nb">parseInt</span> <span class="nx">adjust</span><span class="p">,</span> <span class="mi">10</span></pre></div>             </td>           </tr>                               <tr id="section-119">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-119">&#182;</a>               </div>               <p>It would be easier to do <code>for part in match.split /[\x1e\x1f]/</code>, but IE doesn't return empty matches when using <code>split</code>, throwing off the rest of the logic.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">parts = </span><span class="p">[</span><span class="nx">match</span><span class="p">]</span>
		<span class="k">for</span> <span class="nx">character</span> <span class="k">in</span> <span class="p">[</span><span class="s2">&quot;\x1e&quot;</span><span class="p">,</span> <span class="s2">&quot;\x1f&quot;</span><span class="p">]</span>
			<span class="nv">temp = </span><span class="p">[]</span>
			<span class="k">for</span> <span class="nx">part</span> <span class="k">in</span> <span class="nx">parts</span>
				<span class="nv">temp = </span><span class="nx">temp</span><span class="p">.</span><span class="nx">concat</span> <span class="nx">part</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="nx">character</span><span class="p">)</span>
			<span class="nv">parts = </span><span class="nx">temp</span>

		<span class="k">for</span> <span class="nx">part</span> <span class="k">in</span> <span class="nx">parts</span></pre></div>             </td>           </tr>                               <tr id="section-120">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-120">&#182;</a>               </div>               <p>Start off assuming it's not a book.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nv">switch_type = </span><span class="k">if</span> <span class="nx">switch_type</span> <span class="o">is</span> <span class="s2">&quot;book&quot;</span> <span class="k">then</span> <span class="s2">&quot;rest&quot;</span> <span class="k">else</span> <span class="s2">&quot;book&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-121">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-121">&#182;</a>               </div>               <p>Empty strings don't move the index. This could happen with consecutive books.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nv">part_length = </span><span class="nx">part</span><span class="p">.</span><span class="nx">length</span>
			<span class="k">continue</span> <span class="k">if</span> <span class="nx">part_length</span> <span class="o">==</span> <span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-122">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-122">&#182;</a>               </div>               <p>If it's a book, then get the start index of the actual book, add the length of the actual string, then subtract the length of the integer id and the two surrounding characters.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span> <span class="nx">switch_type</span> <span class="o">==</span> <span class="s2">&quot;book&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-123">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-123">&#182;</a>               </div>               <p>Remove any stray extra indicators.</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nv">part = </span><span class="nx">part</span><span class="p">.</span><span class="nx">replace</span> <span class="sr">/\/[a-z]$/</span><span class="p">,</span> <span class="s2">&quot;&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-124">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-124">&#182;</a>               </div>               <p>Get the length of the id + the surrounding characters. We want the <code>end</code> to be the position, not the length. If the part starts at position 0 and is one character (i.e., three characters total, or <code>\x1f0\x1f</code>), <code>end</code> should be 1, since it occupies positions 0, 1, and 2, and we want the last character to be part of the next index so that we keep track of the end. For example, with "Genesis" at start index 0, the index starting at position 6 ("s") should be 4. Keep the adjust as-is, but set it next.</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nv">end_index = </span><span class="nx">match_index</span> <span class="o">+</span> <span class="nx">part_length</span>
				<span class="k">if</span> <span class="nx">indices</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">indices</span><span class="p">[</span><span class="nx">indices</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="nx">index</span> <span class="o">==</span> <span class="nx">adjust</span>
					<span class="nx">indices</span><span class="p">[</span><span class="nx">indices</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="nv">end = </span><span class="nx">end_index</span>
				<span class="k">else</span>
					<span class="nx">indices</span><span class="p">.</span><span class="nx">push</span> <span class="nv">start: </span><span class="nx">match_index</span><span class="p">,</span> <span class="nv">end: </span><span class="nx">end_index</span><span class="p">,</span> <span class="nv">index: </span><span class="nx">adjust</span></pre></div>             </td>           </tr>                               <tr id="section-125">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-125">&#182;</a>               </div>               <p>If the part is one character (three characters total) starting at <code>match_index</code> 0, we want the next <code>match_index</code> to be 3; it occupies positions 0, 1, and 2. Similarly, if it's two characters, it should be four characters total.</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nx">match_index</span> <span class="o">+=</span> <span class="nx">part_length</span> <span class="o">+</span> <span class="mi">2</span></pre></div>             </td>           </tr>                               <tr id="section-126">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-126">&#182;</a>               </div>               <p>Use the known <code>start_index</code> from the book, subtracting the current index in the match, to get the new. So if the previous <code>match_index</code> == 5 and the book's id is 0, the book's <code>start_index</code> == 10, and the book's length == 7, we want the next adjust to be 10 + 7 - 8 = 9 (the 8 is the <code>match_index</code> where the new <code>adjust</code> starts): 4(+5) = 9, 5(+5) = 10, 6(+5) = 11, 7(+5) = 12, 8(+9) = 17.</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nv">adjust = </span><span class="nx">@books</span><span class="p">[</span><span class="nx">part</span><span class="p">].</span><span class="nx">start_index</span> <span class="o">+</span> <span class="nx">@books</span><span class="p">[</span><span class="nx">part</span><span class="p">].</span><span class="nx">value</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">match_index</span>
				<span class="nx">indices</span><span class="p">.</span><span class="nx">push</span> <span class="nv">start: </span><span class="nx">end_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">end: </span><span class="nx">end_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">index: </span><span class="nx">adjust</span>
			<span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-127">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-127">&#182;</a>               </div>               <p>The <code>- 1</code> is because we want the <code>end</code> to be the position of the last character. If the part starts at position 0 and is three characters long, the <code>end</code> should be two, since it occupies positions 0, 1, and 2.</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nv">end_index = </span><span class="nx">match_index</span> <span class="o">+</span> <span class="nx">part_length</span> <span class="o">-</span> <span class="mi">1</span>
				<span class="k">if</span> <span class="nx">indices</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">indices</span><span class="p">[</span><span class="nx">indices</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="nx">index</span> <span class="o">==</span> <span class="nx">adjust</span>
					<span class="nx">indices</span><span class="p">[</span><span class="nx">indices</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="nv">end = </span><span class="nx">end_index</span>
				<span class="k">else</span>
					<span class="nx">indices</span><span class="p">.</span><span class="nx">push</span> <span class="nv">start: </span><span class="nx">match_index</span><span class="p">,</span> <span class="nv">end: </span><span class="nx">end_index</span><span class="p">,</span> <span class="nv">index: </span><span class="nx">adjust</span>
				<span class="nx">match_index</span> <span class="o">+=</span> <span class="nx">part_length</span>
		<span class="nx">indices</span></pre></div>             </td>           </tr>                               <tr id="section-128">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-128">&#182;</a>               </div>               <p>Find the absolute string indices of start and end points.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">get_absolute_indices: </span><span class="nf">([start, end]) -&gt;</span>
		<span class="nv">start_out = </span><span class="kc">null</span>
		<span class="nv">end_out = </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-129">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-129">&#182;</a>               </div>               <p><code>@indices</code> contains the absolute indices for each range of indices in the string.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">for</span> <span class="nx">index</span> <span class="k">in</span> <span class="nx">@indices</span></pre></div>             </td>           </tr>                               <tr id="section-130">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-130">&#182;</a>               </div>               <p>If we haven't found the absolute start index yet, set it.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span> <span class="nx">start_out</span> <span class="o">is</span> <span class="kc">null</span> <span class="o">and</span> <span class="nx">index</span><span class="p">.</span><span class="nx">start</span> <span class="o">&lt;=</span> <span class="nx">start</span> <span class="o">&lt;=</span> <span class="nx">index</span><span class="p">.</span><span class="nx">end</span>
				<span class="nv">start_out = </span><span class="nx">start</span> <span class="o">+</span> <span class="nx">index</span><span class="p">.</span><span class="nx">index</span></pre></div>             </td>           </tr>                               <tr id="section-131">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-131">&#182;</a>               </div>               <p>This may be in the same loop iteration as <code>start</code>. The <code>+ 1</code> matches Twitter's implementation of indices, where start is the character index and end is the character after the index. So <code>Gen</code> is <code>[0, 3]</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span> <span class="nx">index</span><span class="p">.</span><span class="nx">start</span> <span class="o">&lt;=</span> <span class="nx">end</span> <span class="o">&lt;=</span> <span class="nx">index</span><span class="p">.</span><span class="nx">end</span>
				<span class="nv">end_out = </span><span class="nx">end</span> <span class="o">+</span> <span class="nx">index</span><span class="p">.</span><span class="nx">index</span> <span class="o">+</span> <span class="mi">1</span>
				<span class="k">break</span>
		<span class="p">[</span><span class="nx">start_out</span><span class="p">,</span> <span class="nx">end_out</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-132">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-132">&#182;</a>               </div>               <h2>Validators</h2>

<p>Given a start and optional end bcv object, validate that the verse exists and is valid. It returns an array with validity for each translations.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">validate_ref: </span><span class="nf">(translations, start, end) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-133">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-133">&#182;</a>               </div>               <p>The <code>translation</code> key is optional; if it doesn't exist, assume the default translation.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">translations</span> <span class="o">or=</span> <span class="p">[{</span><span class="nv">translation: </span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="nv">osis: </span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nv">alias: </span><span class="s2">&quot;default&quot;</span><span class="p">}]</span>
		<span class="nv">translation = </span><span class="nx">translations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-134">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-134">&#182;</a>               </div>               <p>Only true if <code>translations</code> isn't the right type.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">return</span> <span class="p">{</span><span class="nv">valid: </span><span class="kc">false</span><span class="p">,</span> <span class="nv">messages: </span><span class="p">{</span><span class="nv">translation_invalid: </span><span class="kc">true</span><span class="p">}}</span> <span class="nx">unless</span> <span class="nx">translation</span><span class="o">?</span>
		<span class="nv">valid = </span><span class="kc">true</span>
		<span class="nv">messages = </span><span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-135">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-135">&#182;</a>               </div>               <p><code>translation</code> is a translation object, but all we care about is the string.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">translation</span><span class="p">.</span><span class="nx">alias</span> <span class="o">?=</span> <span class="s2">&quot;default&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-136">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-136">&#182;</a>               </div>               <p>Only true if <code>translations</code> isn't the right type.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">return</span> <span class="p">{</span><span class="nv">valid: </span><span class="kc">false</span><span class="p">,</span> <span class="nv">messages: </span><span class="p">{</span><span class="nv">translation_invalid: </span><span class="kc">true</span><span class="p">}}</span> <span class="nx">unless</span> <span class="nx">translation</span><span class="p">.</span><span class="nx">alias</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-137">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-137">&#182;</a>               </div>               <p>Not a fatal error because we assume that translations match the default unless we know differently. But we still record it because we may want to know about it later.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">unless</span> <span class="nx">@translations</span><span class="p">[</span><span class="nx">translation</span><span class="p">.</span><span class="nx">alias</span><span class="p">]</span><span class="o">?</span>
			<span class="nv">translation.alias = </span><span class="s2">&quot;default&quot;</span>
			<span class="nv">messages.translation_unknown = </span><span class="kc">true</span>
		<span class="p">[</span><span class="nx">valid</span><span class="p">,</span> <span class="nx">messages</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@validate_start_ref</span> <span class="nx">translation</span><span class="p">.</span><span class="nx">alias</span><span class="p">,</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">valid</span><span class="p">,</span> <span class="nx">messages</span>
		<span class="p">[</span><span class="nx">valid</span><span class="p">,</span> <span class="nx">messages</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@validate_end_ref</span> <span class="nx">translation</span><span class="p">.</span><span class="nx">alias</span><span class="p">,</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">end</span><span class="p">,</span> <span class="nx">valid</span><span class="p">,</span> <span class="nx">messages</span> <span class="k">if</span> <span class="nx">end</span>
		<span class="nv">valid: </span><span class="nx">valid</span><span class="p">,</span> <span class="nv">messages: </span><span class="nx">messages</span></pre></div>             </td>           </tr>                               <tr id="section-138">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-138">&#182;</a>               </div>               <p>Make sure that the start ref exists in the given translation.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">validate_start_ref: </span><span class="nf">(translation, start, valid, messages) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-139">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-139">&#182;</a>               </div>               <p>Matt</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span> <span class="nx">@translations</span><span class="p">[</span><span class="nx">translation</span><span class="p">].</span><span class="nx">order</span><span class="p">[</span><span class="nx">start</span><span class="p">.</span><span class="nx">b</span><span class="p">]</span><span class="o">?</span>
			<span class="nx">start</span><span class="p">.</span><span class="nx">c</span> <span class="o">?=</span> <span class="mi">1</span>
			<span class="nv">start.c = </span><span class="nb">parseInt</span> <span class="nx">start</span><span class="p">.</span><span class="nx">c</span><span class="p">,</span> <span class="mi">10</span></pre></div>             </td>           </tr>                               <tr id="section-140">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-140">&#182;</a>               </div>               <p>Matt five</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span> <span class="nb">isNaN</span> <span class="nx">start</span><span class="p">.</span><span class="nx">c</span>
				<span class="nv">valid = </span><span class="kc">false</span>
				<span class="nv">messages.start_chapter_not_numeric = </span><span class="kc">true</span>
				<span class="k">return</span> <span class="p">[</span><span class="nx">valid</span><span class="p">,</span> <span class="nx">messages</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-141">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-141">&#182;</a>               </div>               <p>Matt 0</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span> <span class="nx">start</span><span class="p">.</span><span class="nx">c</span> <span class="o">==</span> <span class="mi">0</span>
				<span class="nv">messages.start_chapter_is_zero = </span><span class="mi">1</span>
				<span class="k">if</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">zero_chapter_strategy</span> <span class="o">is</span> <span class="s2">&quot;error&quot;</span> <span class="k">then</span> <span class="nv">valid = </span><span class="kc">false</span>
				<span class="k">else</span> <span class="nv">start.c = </span><span class="mi">1</span></pre></div>             </td>           </tr>                               <tr id="section-142">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-142">&#182;</a>               </div>               <p>Matt 5</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span> <span class="nx">start</span><span class="p">.</span><span class="nx">c</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">@translations</span><span class="p">[</span><span class="nx">translation</span><span class="p">].</span><span class="nx">chapters</span><span class="p">[</span><span class="nx">start</span><span class="p">.</span><span class="nx">b</span><span class="p">][</span><span class="nx">start</span><span class="p">.</span><span class="nx">c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-143">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-143">&#182;</a>               </div>               <p>Matt 5:10</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="k">if</span> <span class="nx">start</span><span class="p">.</span><span class="nx">v</span><span class="o">?</span>
					<span class="nv">start.v = </span><span class="nb">parseInt</span> <span class="nx">start</span><span class="p">.</span><span class="nx">v</span><span class="p">,</span> <span class="mi">10</span></pre></div>             </td>           </tr>                               <tr id="section-144">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-144">&#182;</a>               </div>               <p>Matt 5:ten</p>             </td>             <td class="code">               <div class="highlight"><pre>					<span class="k">if</span> <span class="nb">isNaN</span> <span class="nx">start</span><span class="p">.</span><span class="nx">v</span>
						<span class="nv">valid = </span><span class="kc">false</span>
						<span class="nv">messages.start_verse_not_numeric = </span><span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-145">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-145">&#182;</a>               </div>               <p>Matt 5:0</p>             </td>             <td class="code">               <div class="highlight"><pre>					<span class="k">else</span> <span class="k">if</span> <span class="nx">start</span><span class="p">.</span><span class="nx">v</span> <span class="o">==</span> <span class="mi">0</span>
						<span class="nv">messages.start_verse_is_zero = </span><span class="mi">1</span>
						<span class="k">if</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">zero_verse_strategy</span> <span class="o">is</span> <span class="s2">&quot;error&quot;</span> <span class="k">then</span> <span class="nv">valid = </span><span class="kc">false</span>
						<span class="k">else</span> <span class="k">if</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">zero_verse_strategy</span> <span class="o">is</span> <span class="s2">&quot;upgrade&quot;</span> <span class="k">then</span> <span class="nv">start.v = </span><span class="mi">1</span></pre></div>             </td>           </tr>                               <tr id="section-146">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-146">&#182;</a>               </div>               <p>Matt 5:100</p>             </td>             <td class="code">               <div class="highlight"><pre>					<span class="k">else</span> <span class="k">if</span> <span class="nx">start</span><span class="p">.</span><span class="nx">v</span> <span class="o">&gt;</span> <span class="nx">@translations</span><span class="p">[</span><span class="nx">translation</span><span class="p">].</span><span class="nx">chapters</span><span class="p">[</span><span class="nx">start</span><span class="p">.</span><span class="nx">b</span><span class="p">][</span><span class="nx">start</span><span class="p">.</span><span class="nx">c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
						<span class="nv">valid = </span><span class="kc">false</span>
						<span class="nv">messages.start_verse_not_exist = </span><span class="nx">@translations</span><span class="p">[</span><span class="nx">translation</span><span class="p">].</span><span class="nx">chapters</span><span class="p">[</span><span class="nx">start</span><span class="p">.</span><span class="nx">b</span><span class="p">][</span><span class="nx">start</span><span class="p">.</span><span class="nx">c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-147">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-147">&#182;</a>               </div>               <p>Matt 50</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">else</span>
				<span class="nv">valid = </span><span class="kc">false</span>
				<span class="k">if</span> <span class="nx">start</span><span class="p">.</span><span class="nx">c</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">and</span> <span class="nx">@translations</span><span class="p">[</span><span class="nx">translation</span><span class="p">].</span><span class="nx">chapters</span><span class="p">[</span><span class="nx">start</span><span class="p">.</span><span class="nx">b</span><span class="p">].</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">1</span>
					<span class="nv">messages.start_chapter_not_exist_in_single_chapter_book = </span><span class="mi">1</span>
				<span class="k">else</span> <span class="k">if</span> <span class="nx">start</span><span class="p">.</span><span class="nx">c</span> <span class="o">&gt;</span> <span class="mi">0</span>
					<span class="nv">messages.start_chapter_not_exist = </span><span class="nx">@translations</span><span class="p">[</span><span class="nx">translation</span><span class="p">].</span><span class="nx">chapters</span><span class="p">[</span><span class="nx">start</span><span class="p">.</span><span class="nx">b</span><span class="p">].</span><span class="nx">length</span></pre></div>             </td>           </tr>                               <tr id="section-148">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-148">&#182;</a>               </div>               <p>None 2:1</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">else</span>
			<span class="nv">valid = </span><span class="kc">false</span>
			<span class="nv">messages.start_book_not_exist = </span><span class="kc">true</span>
		<span class="p">[</span><span class="nx">valid</span><span class="p">,</span> <span class="nx">messages</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-149">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-149">&#182;</a>               </div>               <p>The end ref pretty much just has to be after the start ref; beyond the book, we don't    require that the chapter or verse exists. This is useful when people get end verses wrong.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">validate_end_ref: </span><span class="nf">(translation, start, end, valid, messages) -&gt;</span>
		<span class="nv">end.c = </span><span class="nb">parseInt</span> <span class="nx">end</span><span class="p">.</span><span class="nx">c</span><span class="p">,</span> <span class="mi">10</span> <span class="k">if</span> <span class="nx">end</span><span class="p">.</span><span class="nx">c</span><span class="o">?</span>
		<span class="nv">end.v = </span><span class="nb">parseInt</span> <span class="nx">end</span><span class="p">.</span><span class="nx">v</span><span class="p">,</span> <span class="mi">10</span> <span class="k">if</span> <span class="nx">end</span><span class="p">.</span><span class="nx">v</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-150">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-150">&#182;</a>               </div>               <p>Matt 0</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span> <span class="nx">end</span><span class="p">.</span><span class="nx">c</span><span class="o">?</span> <span class="o">and</span> <span class="o">not</span><span class="p">(</span><span class="nb">isNaN</span> <span class="nx">end</span><span class="p">.</span><span class="nx">c</span><span class="p">)</span> <span class="o">and</span> <span class="nx">end</span><span class="p">.</span><span class="nx">c</span> <span class="o">==</span> <span class="mi">0</span>
			<span class="nv">messages.end_chapter_is_zero = </span><span class="mi">1</span>
			<span class="k">if</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">zero_chapter_strategy</span> <span class="o">is</span> <span class="s2">&quot;error&quot;</span> <span class="k">then</span> <span class="nv">valid = </span><span class="kc">false</span>
			<span class="k">else</span> <span class="nv">end.c = </span><span class="mi">1</span></pre></div>             </td>           </tr>                               <tr id="section-151">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-151">&#182;</a>               </div>               <p>Matt-Mark</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span> <span class="nx">@translations</span><span class="p">[</span><span class="nx">translation</span><span class="p">].</span><span class="nx">order</span><span class="p">[</span><span class="nx">end</span><span class="p">.</span><span class="nx">b</span><span class="p">]</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-152">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-152">&#182;</a>               </div>               <p>Mark 4-Matt 5, None 4-Matt 5</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span> <span class="nx">@translations</span><span class="p">[</span><span class="nx">translation</span><span class="p">].</span><span class="nx">order</span><span class="p">[</span><span class="nx">start</span><span class="p">.</span><span class="nx">b</span><span class="p">]</span><span class="o">?</span> <span class="o">and</span> <span class="nx">@translations</span><span class="p">[</span><span class="nx">translation</span><span class="p">].</span><span class="nx">order</span><span class="p">[</span><span class="nx">start</span><span class="p">.</span><span class="nx">b</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nx">@translations</span><span class="p">[</span><span class="nx">translation</span><span class="p">].</span><span class="nx">order</span><span class="p">[</span><span class="nx">end</span><span class="p">.</span><span class="nx">b</span><span class="p">]</span>
				<span class="nv">valid = </span><span class="kc">false</span>
				<span class="nv">messages.end_book_before_start = </span><span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-153">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-153">&#182;</a>               </div>               <p>Matt 5-6</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span> <span class="nx">start</span><span class="p">.</span><span class="nx">b</span> <span class="o">==</span> <span class="nx">end</span><span class="p">.</span><span class="nx">b</span> <span class="o">and</span> <span class="nx">end</span><span class="p">.</span><span class="nx">c</span><span class="o">?</span> <span class="o">and</span> <span class="o">not</span> <span class="nb">isNaN</span> <span class="nx">end</span><span class="p">.</span><span class="nx">c</span></pre></div>             </td>           </tr>                               <tr id="section-154">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-154">&#182;</a>               </div>               <p>Matt-Matt 4</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nx">start</span><span class="p">.</span><span class="nx">c</span> <span class="o">?=</span> <span class="mi">1</span></pre></div>             </td>           </tr>                               <tr id="section-155">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-155">&#182;</a>               </div>               <p>Matt 5-4</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="k">if</span> <span class="o">not</span> <span class="nb">isNaN</span><span class="p">(</span><span class="nb">parseInt</span> <span class="nx">start</span><span class="p">.</span><span class="nx">c</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">and</span> <span class="nx">start</span><span class="p">.</span><span class="nx">c</span> <span class="o">&gt;</span> <span class="nx">end</span><span class="p">.</span><span class="nx">c</span>
					<span class="nv">valid = </span><span class="kc">false</span>
					<span class="nv">messages.end_chapter_before_start = </span><span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-156">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-156">&#182;</a>               </div>               <p>Matt 5:7-5:8</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="k">else</span> <span class="k">if</span> <span class="nx">start</span><span class="p">.</span><span class="nx">c</span> <span class="o">==</span> <span class="nx">end</span><span class="p">.</span><span class="nx">c</span> <span class="o">and</span> <span class="nx">end</span><span class="p">.</span><span class="nx">v</span><span class="o">?</span> <span class="o">and</span> <span class="o">not</span> <span class="nb">isNaN</span> <span class="nx">end</span><span class="p">.</span><span class="nx">v</span></pre></div>             </td>           </tr>                               <tr id="section-157">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-157">&#182;</a>               </div>               <p>Matt 5-5:8</p>             </td>             <td class="code">               <div class="highlight"><pre>					<span class="nx">start</span><span class="p">.</span><span class="nx">v</span> <span class="o">?=</span> <span class="mi">1</span></pre></div>             </td>           </tr>                               <tr id="section-158">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-158">&#182;</a>               </div>               <p>Matt 5:8-7</p>             </td>             <td class="code">               <div class="highlight"><pre>					<span class="k">if</span> <span class="o">not</span> <span class="nb">isNaN</span><span class="p">(</span><span class="nb">parseInt</span> <span class="nx">start</span><span class="p">.</span><span class="nx">v</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">and</span> <span class="nx">start</span><span class="p">.</span><span class="nx">v</span> <span class="o">&gt;</span> <span class="nx">end</span><span class="p">.</span><span class="nx">v</span>
						<span class="nv">valid = </span><span class="kc">false</span>
						<span class="nv">messages.end_verse_before_start = </span><span class="kc">true</span>
			<span class="k">if</span> <span class="nx">end</span><span class="p">.</span><span class="nx">c</span><span class="o">?</span> <span class="o">and</span> <span class="o">not</span> <span class="nb">isNaN</span> <span class="nx">end</span><span class="p">.</span><span class="nx">c</span>
				<span class="k">if</span> <span class="o">not</span> <span class="nx">@translations</span><span class="p">[</span><span class="nx">translation</span><span class="p">].</span><span class="nx">chapters</span><span class="p">[</span><span class="nx">end</span><span class="p">.</span><span class="nx">b</span><span class="p">][</span><span class="nx">end</span><span class="p">.</span><span class="nx">c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">?</span>
					<span class="k">if</span> <span class="nx">@translations</span><span class="p">[</span><span class="nx">translation</span><span class="p">].</span><span class="nx">chapters</span><span class="p">[</span><span class="nx">end</span><span class="p">.</span><span class="nx">b</span><span class="p">].</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">1</span>
						<span class="nv">messages.end_chapter_not_exist_in_single_chapter_book = </span><span class="mi">1</span>
					<span class="k">else</span> <span class="k">if</span> <span class="nx">end</span><span class="p">.</span><span class="nx">c</span> <span class="o">&gt;</span> <span class="mi">0</span>
						<span class="nv">messages.end_chapter_not_exist = </span><span class="nx">@translations</span><span class="p">[</span><span class="nx">translation</span><span class="p">].</span><span class="nx">chapters</span><span class="p">[</span><span class="nx">end</span><span class="p">.</span><span class="nx">b</span><span class="p">].</span><span class="nx">length</span>
			<span class="k">if</span> <span class="nx">end</span><span class="p">.</span><span class="nx">v</span><span class="o">?</span> <span class="o">and</span> <span class="o">not</span> <span class="nb">isNaN</span> <span class="nx">end</span><span class="p">.</span><span class="nx">v</span>
				<span class="nx">end</span><span class="p">.</span><span class="nx">c</span> <span class="o">?=</span> <span class="nx">@translations</span><span class="p">[</span><span class="nx">translation</span><span class="p">].</span><span class="nx">chapters</span><span class="p">[</span><span class="nx">end</span><span class="p">.</span><span class="nx">b</span><span class="p">].</span><span class="nx">length</span>
				<span class="k">if</span> <span class="nx">end</span><span class="p">.</span><span class="nx">v</span> <span class="o">&gt;</span> <span class="nx">@translations</span><span class="p">[</span><span class="nx">translation</span><span class="p">].</span><span class="nx">chapters</span><span class="p">[</span><span class="nx">end</span><span class="p">.</span><span class="nx">b</span><span class="p">][</span><span class="nx">end</span><span class="p">.</span><span class="nx">c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
					<span class="nv">messages.end_verse_not_exist = </span><span class="nx">@translations</span><span class="p">[</span><span class="nx">translation</span><span class="p">].</span><span class="nx">chapters</span><span class="p">[</span><span class="nx">end</span><span class="p">.</span><span class="nx">b</span><span class="p">][</span><span class="nx">end</span><span class="p">.</span><span class="nx">c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
				<span class="k">else</span> <span class="k">if</span> <span class="nx">end</span><span class="p">.</span><span class="nx">v</span> <span class="o">==</span> <span class="mi">0</span>
					<span class="nv">messages.end_verse_is_zero = </span><span class="mi">1</span>
					<span class="k">if</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">zero_verse_strategy</span> <span class="o">is</span> <span class="s2">&quot;error&quot;</span> <span class="k">then</span> <span class="nv">valid = </span><span class="kc">false</span>
					<span class="k">else</span> <span class="k">if</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">zero_verse_strategy</span> <span class="o">is</span> <span class="s2">&quot;upgrade&quot;</span> <span class="k">then</span> <span class="nv">end.v = </span><span class="mi">1</span></pre></div>             </td>           </tr>                               <tr id="section-159">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-159">&#182;</a>               </div>               <p>Matt 5:1-None 6</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">else</span>
			<span class="nv">valid = </span><span class="kc">false</span>
			<span class="nv">messages.end_book_not_exist = </span><span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-160">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-160">&#182;</a>               </div>               <p>Matt 2-four</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span> <span class="nx">end</span><span class="p">.</span><span class="nx">c</span><span class="o">?</span> <span class="o">and</span> <span class="nb">isNaN</span> <span class="nx">end</span><span class="p">.</span><span class="nx">c</span>
			<span class="nv">valid = </span><span class="kc">false</span>
			<span class="nv">messages.end_chapter_not_numeric = </span><span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-161">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-161">&#182;</a>               </div>               <p>Matt 5:7-eight</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span> <span class="nx">end</span><span class="p">.</span><span class="nx">v</span><span class="o">?</span> <span class="o">and</span> <span class="nb">isNaN</span> <span class="nx">end</span><span class="p">.</span><span class="nx">v</span>
			<span class="nv">valid = </span><span class="kc">false</span>
			<span class="nv">messages.end_verse_not_numeric = </span><span class="kc">true</span>
		<span class="p">[</span><span class="nx">valid</span><span class="p">,</span> <span class="nx">messages</span><span class="p">]</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 